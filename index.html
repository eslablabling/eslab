<!DOCTYPE html>
<html lang="id">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>PT Envirotama Solusindo LIMS</title>
    
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
        <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
        
        <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.21/lodash.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
         

        <style>
            :root { 
                --primary: #4a90e2; --bg: #f4f7fa; --sidebar: #ffffff; --section: #ffffff; 
                --text-main: #334155; --text-muted: #64748b; --border: #e2e8f0; 
                --danger: #e11d48; --success: #10b981; --warning: #f39c12;
            }

            * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Plus Jakarta Sans', sans-serif; }
            body { background-color: var(--bg); color: var(--text-main); overflow-x: hidden; }
            
            /* Auth & Layout */
            #login-page { height: 100vh; display: flex; align-items: center; justify-content: center; background: linear-gradient(135deg, #a1c4fd 0%, #c2e9fb 100%); }
            .login-box { background: white; padding: 40px; border-radius: 24px; width: 380px; text-align: center; box-shadow: 0 10px 25px rgba(0,0,0,0.05); }
            .container { display: flex; min-height: 100vh; }
            .sidebar { width: 260px; background: var(--sidebar); padding: 30px 20px; border-right: 1px solid var(--border); position: sticky; top: 0; height: 100vh; }
            .sidebar h2 { color: var(--primary); margin-bottom: 30px; text-align: center; font-weight: 800; font-size: 1.2rem; }
            .sidebar ul { list-style: none; }
            .sidebar ul li button { color: var(--text-muted); text-decoration: none; padding: 12px 15px; display: flex; align-items: center; justify-content: space-between; border-radius: 12px; margin-bottom: 5px; transition: 0.3s; cursor: pointer; background: none; border: none; width: 100%; text-align: left; }
            .sidebar ul li button.active, .sidebar ul li button:hover { background: #eef5fd; color: var(--primary); }
            .badge-count {min-width: 20px;    height: 20px;display: inline-flex;    align-items: center;justify-content: center;    border-radius: 50%; /* Membuat lingkaran */font-size: 0.7rem;    color: white;    margin-left: 10px;    padding: 2px 6px;}       .content { flex: 1; padding: 40px; }
            .section-box { background: var(--section); border-radius: 18px; padding: 25px; border: 1px solid var(--border); margin-bottom: 25px; box-shadow: 0 4px 6px rgba(0,0,0,0.02); }
            .stat-card { background: var(--section); padding: 20px; border-radius: 16px; border: 1px solid var(--border); text-align: center; border-top: 4px solid var(--primary); }
            .btn-primary { background: var(--primary); color: white; border: none; padding: 10px 20px; border-radius: 10px; cursor: pointer; font-weight: 600; transition: 0.2s; }
            .btn-primary:hover { opacity: 0.8; }
            .lab-table { width: 100%; border-collapse: collapse; margin-top: 15px; }
            .lab-table th {padding: 12px;text-align: left;color: var(--text-muted);border-bottom: 2px solid var(--bg);font-size: 0.8rem; text-transform: none; font-weight: 700;}
            .lab-table td { padding: 12px; border-bottom: 1px solid var(--bg); font-size: 0.85rem; }
            .toast-container { position: fixed; top: 20px; right: 20px; z-index: 9999; }
            .toast { background: #1e293b; color: white; padding: 12px 20px; border-radius: 10px; margin-bottom: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); animation: slideIn 0.3s ease-out; }
            @keyframes slideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }
        </style>
    </head>
<body>

    <!-- LOGIN PAGE -->
        <div id="login-page">
            <div class="login-box"style="width: 450px;">    
            <!-- Tambahkan Logo di sini -->
            <img src="logo_eslab.jpg" alt="Logo PT Envirotama Solusindo" style="width: 280px; margin-bottom: 25px;">
            
            <h2 style="color: var(--primary); margin-bottom: 5px; font-size: 1.4rem;">PT ENVIROTAMA SOLUSINDO</h2>
            <p style="color: var(--text-muted); font-size: 0.8rem; margin-bottom: 25px;">Laboratory Management System</p>
            
            <form id="login-form">
                <input type="text" id="username" placeholder="Username" required style="width:100%; padding:12px; margin-bottom:10px; border-radius:10px; border:1px solid #ddd; outline:none;">
                <input type="password" id="password" placeholder="Password" required style="width:100%; padding:12px; margin-bottom:20px; border-radius:10px; border:1px solid #ddd; outline:none;">
                <button type="submit" class="btn-primary" style="width: 100%;">LOGIN</button>
            </form>
            </div>
        </div>

    <!-- MAIN DASHBOARD -->
    <div id="main-dashboard" class="container" style="display: none;">
        <nav class="sidebar">
            <h2 id="role-tag">LAB SYSTEM</h2>
            <ul>
                <li><button onclick="showSection('view-home', this)" class="menu-link active"><span><i class="fas fa-home"></i> Dashboard</span></button></li>
                <li id="m-master"><button onclick="showSection('view-master', this)" class="menu-link"><span><i class="fas fa-database"></i> Master Data</span></button></li>
                <li id="m-coc"><button onclick="showSection('view-coc', this); renderCOC();" class="menu-link coc-menu"><span><i class="fas fa-file-signature"></i> Pembuatan COC</span></button></li>
                <li><button onclick="showSection('view-coc-list', this)" class="menu-link"><span><i class="fas fa-list"></i> Lihat COC</span></button></li>
                <li id="m-sampel"><button onclick="showSection('view-sampel', this)" class="menu-link"><span><i class="fas fa-box-open"></i> Penerimaan</span></button></li>
                <li><button onclick="showSection('view-input-sampling', this)" class="menu-link"><span><i class="fas fa-edit"></i> Input Data</span></button></li>
                <li><button onclick="showSection('view-analisa', this)" class="menu-link"><span><i class="fas fa-microscope"></i> Analisa</span> <span id="badge-analisa" class="badge-count" style="background:var(--danger)">0</span></button></li>
                <li id="m-coa"><button onclick="showSection('view-coa', this)" class="menu-link"><span><i class="fas fa-file-contract"></i> Selesai</span> <span id="badge-coa" class="badge-count" style="background:var(--danger)">0</span></button></li>
                <li id="m-logs" style="display:none;"><button onclick="showSection('view-logs', this); renderLogs();" class="menu-link"><span><i class="fas fa-history"></i> Audit Log</span></button></li>
                <li id="m-recycle" style="display:none;"><button onclick="showSection('view-recycle', this); renderRecycleBin();" class="menu-link"><span><i class="fas fa-trash-restore"></i> Recycle Bin</span></button></li>
                <li style="margin-top:50px;"><button onclick="logout()" style="color:var(--danger); background:none; border:none; cursor:pointer;"><i class="fas fa-sign-out-alt"></i> Keluar</button></li>
                
            </ul>
        </nav>

        <main class="content">
            <header style="margin-bottom: 30px; display: flex; justify-content: space-between; align-items: center;">
                <h1 id="view-title">Dashboard</h1>
                <p id="live-date" style="color: var(--text-muted); font-size: 0.9rem;"></p>
            </header>

            <!-- SECTION HOME -->
            <div id="view-home" class="section-container">
                <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap:20px; margin-bottom:25px;">
                    <div class="stat-card"><h4>Total Masuk</h4><p id="stat-total" style="font-size:1.5rem; font-weight:800;">0</p></div>
                    <div class="stat-card" style="border-top-color:var(--warning)"><h4>Proses Analisa</h4><p id="stat-proses" style="font-size:1.5rem; font-weight:800;">0</p></div>
                    <div class="stat-card" style="border-top-color:var(--success)"><h4>Selesai</h4><p id="stat-selesai" style="font-size:1.5rem; font-weight:800;">0</p></div>
                </div>
                <section class="section-box">
                    <div style="height: 300px;"><canvas id="labChart"></canvas></div>
                </section>
            </div>

            <!-- SECTION MASTER -->
            <div id="view-master" class="section-container" style="display:none;">
                <div class="section-box" style="display:flex; gap:10px; align-items:center;">
                    <strong>Database:</strong>
                    <button onclick="exportJSON()" class="btn-primary" style="background:#334155; font-size:0.75rem;">Export JSON</button>
                    <input type="file" id="import-file" style="display:none;" onchange="importJSON(event)">
                    <button onclick="document.getElementById('import-file').click()" class="btn-primary" style="background:#64748b; font-size:0.75rem;">Import JSON</button>
                    <button onclick="resetDB()" class="btn-primary" style="background:var(--danger); font-size:0.75rem;">Reset Semua</button>
                </div>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 20px;">
                    <section class="section-box">
                        <h4>Master Regulasi</h4>
                        <div style="display:flex; flex-direction:column; gap:10px; margin:15px 0;">
                            <input type="text" id="m-reg-in" placeholder="Nama Regulasi (ex: PermenLHK 15/2019)..." style="padding:10px; border-radius:8px; border:1px solid var(--border);">
                            <div style="display:flex; gap:10px;">
                                <input type="number" id="m-o2-in" placeholder="O2 Koreksi (%)" style="flex:1; padding:10px; border-radius:8px; border:1px solid var(--border);">
                                <input type="number" id="m-limit-in" placeholder="Limit Baku Mutu" style="flex:1; padding:10px; border-radius:8px; border:1px solid var(--border);">
                            </div>
                            <button onclick="addReg()" class="btn-primary">Tambah Regulasi</button>
                        </div>
                        <ul id="list-reg" style="list-style:none;"></ul>
                    </section>
                    <section class="section-box">
                        <h4>Mapping Parameter & Metode</h4>
                        <div style="display:flex; flex-direction:column; gap:10px; margin:15px 0;">
                            <input type="text" id="m-param-in" placeholder="Parameter (ex: pH)..." style="padding:10px; border-radius:8px; border:1px solid var(--border);">
                            <input type="text" id="m-met-in" placeholder="Metode (ex: SNI...)..." style="padding:10px; border-radius:8px; border:1px solid var(--border);">
                            <button onclick="addMap()" class="btn-primary">Petakan Data</button>
                        </div>
                        <div id="list-mapping"></div>
                    </section>
                </div>
            </div>
            
            <!-- SECTION COC -->
            <div id="view-coc" class="section-container" style="display:none;">
                <section class="section-box" style="padding: 10px; font-family: 'Plus Jakarta Sans', sans-serif;">
                    <div style="display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #ddd; padding-bottom: 10px;">
                        <!-- Bagian informasi perusahaan sudah dihapus -->
                        <div style="font-size: 14px; font-weight: bold; padding: 5px; border: 1px solid #ccc; background-color: #f9f9f9;">
                            CHAIN OF CUSTODY (COC)
                        </div>
                        <button onclick="newCOC()" style="background:#2c7be5; color:white; border:none; padding:6px 10px;">
                            + COC Baru
                        </button>
                        <div style="margin-bottom:10px;">
                            <select id="coc-select" onchange="loadCOC(this.value)">
                                <option value="">-- Pilih COC Tersimpan --</option>
                            </select>

                            <button onclick="deleteCOC()" style="margin-left:5px; background:red; color:white; border:none; padding:5px 8px;">
                                Hapus COC
                            </button>
                        </div>
                        <button onclick="printCOC()" class="btn-primary" style="margin-left: 15px;">
                            <i class="fas fa-file-pdf"></i> Cetak PDF
                        </button>
                        <button onclick="saveCOC()" class="btn-primary" style="margin-left: 10px;">
                            <i class="fas fa-save"></i> Simpan COC
                        </button>
                        <button onclick="addCOCRow()" class="btn-primary">
                            <i class="fas fa-plus"></i> Tambah Sampel
                        </button>
                    </div>


                    <!-- MAIN FORM TABLE -->
                    <table style="width: 100%; margin-top: 10px; border-collapse: collapse; font-size: 9px; border: 1px solid #000;">
                        <!-- Row 1: Company Info -->
                        <tr>
                            <td style="width: 20%; padding: 4px; border: 1px solid #000;">Company Name</td>
                            <td style="width: 30%; padding: 4px; border: 1px solid #000;"><input type="text" id="coc-company-name" style="width:100%; border:none;"></td>
                            <!-- Label Email (COA) dengan rowspan="2" -->
                            <td rowspan="2" style="width: 15%; padding: 4px; border: 1px solid #000;">Email (COA)</td>
                            <!-- Input Email (COA) dengan rowspan="2" dan ID baru -->
                            <td rowspan="2" style="padding: 4px; border: 1px solid #000;"><input type="text" id="coc-email-coa" style="width:100%; border:none; height:100%;"></td>
                            <td style="width: 10%; padding: 4px; border: 1px solid #000;">COC No.</td>
                            <td style="width: 20%; padding: 4px; border: 1px solid #000;"><input type="text" id="coc-coc-no" value="ES-COC" style="width:100%; border:none;"></td>
                        </tr>
                        <!-- Row 2: Address/Location Info -->
                        <tr>
                            <td style="padding: 4px; border: 1px solid #000;">Company Address</td>
                            <td style="padding: 4px; border: 1px solid #000;"><input type="text" id="coc-company-address" style="width:100%; border:none;"></td>
                            <!-- Kolom 3 & 4 (Email COA input) sudah digabung ke atas, jadi di baris ini mulai dari kolom LTR No. -->
                            <td style="padding: 4px; border: 1px solid #000;">LTR No.</td>
                            <td style="padding: 4px; border: 1px solid #000;"><input type="text" id="coc-ltr-no" value="0" style="width:100%; border:none;"></td>
                        </tr>


                       <!-- Row 3: Location Details & TAT -->
                        <tr>
                            <td rowspan="2" style="padding: 4px; border: 1px solid #000;">Sampling Location</td>
                            <td rowspan="2" style="padding: 4px; border: 1px solid #000;"><textarea id="coc-company-location-detail" style="width:100%; border:none; height:100%; font-family: inherit; font-size: 9px; resize: none;"></textarea></td>
                            <td style="padding: 4px; border: 1px solid #000;">TAT Requested</td>
                            <td style="padding: 4px; border: 1px solid #000; font-weight: bold;"><input type="text" id="coc-tat-req" value="NORMAL" style="width:100%; border:none;"></td>
                            <td style="padding: 4px; border: 1px solid #000;">Sampling Officer</td>
                            <td style="padding: 4px; border: 1px solid #000;"><input type="text" id="coc-officer-a" style="width:100%; border:none;"></td>
                        </tr>
                        <!-- Row 4: Plan Date & Officer 2 -->
                        <tr>
                            <td style="padding: 4px; border: 1px solid #000;">Sampling Plan Date</td>
                            <td style="padding: 4px; border: 1px solid #000;"><input type="date" id="coc-plan-date" style="width:100%; border:none;"></td>
                            <td style="padding: 4px; border: 1px solid #000;">Sampling Officer 2</td>
                            <td style="padding: 4px; border: 1px solid #000;"><input type="text" id="coc-officer-b" style="width:100%; border:none;"></td>
                        </tr>
                        <!-- Row 5: PIC Contact Info (Kolom kosong dihapus) -->
                        <tr>
                            <td style="padding: 4px; border: 1px solid #000;">PIC</td>
                            <td style="padding: 4px; border: 1px solid #000;"><input type="text" id="coc-pic" style="width:100%; border:none;"></td>
                            <td style="padding: 4px; border: 1px solid #000;">Phone No.</td>
                            <td style="padding: 4px; border: 1px solid #000;"><input type="text" id="coc-phone-no" style="width:100%; border:none;"></td>
                            <td style="padding: 4px; border: 1px solid #000;">Sampling Officer 3</td>
                            <td style="padding: 4px; border: 1px solid #000;"><input type="text" id="coc-officer-c" style="width:100%; border:none;"></td>
                        </tr>

                    </table>

                    <!-- SAMPLES TABLE -->
                    <table style="width: 100%; margin-top: 15px; border-collapse: collapse; font-size: 8px; border: 1px solid #000;">
                        <thead>
                            <tr>
                                <th style="border: 1px solid #000; padding: 5px;">No.</th>
                                <th style="border: 1px solid #000; padding: 5px;">Sampel ID</th>
                                <th style="border: 1px solid #000; padding: 5px;">Description</th>
                                <th style="border: 1px solid #000; padding: 5px;">Samples Matrix</th>
                                <th style="border: 1px solid #000; padding: 5px;">Sample Container</th>
                                <th style="border: 1px solid #000; padding: 5px;">Regulation</th>
                                <th style="border: 1px solid #000; padding: 5px;">Testing Parameter</th>
                                <th style="border: 1px solid #000; padding: 5px;">Methods</th>
                            </tr>
                        </thead>
                        
                        <tbody id="coc-samples-body">
                        </tbody>
                    </table>
                </section>
            </div>

            <!-- SECTION LIAT COC -->
             <div id="view-coc-list" class="content-section" style="display:none;">
                
                    <h2>Daftar COC</h2>
                    <div style="margin-bottom:10px;">
                        <input 
                            type="text" 
                            id="search-coc"
                            placeholder="Cari COC"
                            onkeyup="searchCOC()"
                            style="padding:6px; width:250px;"
                        >
                    </div>
                    <table border="1" width="100%" style="border-collapse:collapse;">
                        <thead style="background:#f0f0f0;">
                            <tr>
                                <th>No</th>
                                <th>No COC</th>
                                <th>Perusahaan</th>
                                <th>Tanggal Rencana</th>
                                <th>Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="coc-list-body">
                        </tbody>
                    </table>

                </div>

            <!-- SECTION LOG -->
                <div id="view-logs" class="section-container" style="display:none;">
                    <section class="section-box">
                        <header style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                            <h3>Audit Trail - Log Aktivitas</h3>
                            <button onclick="if(confirm('Hapus semua log?')){logs=[]; localStorage.removeItem('lab_audit_logs'); renderLogs();}" class="btn-primary" style="background:var(--danger); font-size:0.75rem;">Clear Logs</button>
                        </header>
                        <div style="overflow-y: auto; max-height: 500px;">
                            <table class="lab-table">
                                <thead>
                                    <tr>
                                        <th>Waktu</th>
                                        <th>User</th>
                                        <th>Aksi</th>
                                        <th>Detail Perubahan</th>
                                    </tr>
                                </thead>
                                <tbody id="body-logs"></tbody>
                            </table>
                        </div>
                    </section>
                </div>

                <!-- SECTION SAMPAH -->
                <div id="view-recycle" class="section-container" style="display:none;">
                    <section class="section-box">
                        <h3><i class="fas fa-trash-restore"></i> Recycle Bin (Tempat Sampah)</h3>
                        <table class="lab-table">
                            <thead>
                                <tr>
                                    <th>ID Sampel</th>
                                    <th>Dihapus Pada</th>
                                    <th>Aksi</th>
                                </tr>
                            </thead>
                            <tbody id="body-recycle"></tbody>
                        </table>
                    </section>
                </div>


            <!-- SECTION SAMPEL -->
            <div id="view-sampel" class="section-container" style="display:none;">
                            <section class="section-box">
                                <form id="sample-form" style="display:grid; grid-template-columns:repeat(auto-fit, minmax(250px,1fr)); gap:15px;">
                                    <div style="display:flex; flex-direction:column; gap:5px;"><label for="s-id">ID Sampel</label><input type="text" id="s-id" required style="padding:10px; border-radius:8px; border:1px solid var(--border);"></div>
                                    <div style="display:flex; flex-direction:column; gap:5px;"><label for="s-company">Perusahaan</label><input type="text" id="s-company" required style="padding:10px; border-radius:8px; border:1px solid var(--border);"></div>
                                    <div style="display:flex; flex-direction:column; gap:5px;"><label for="s-company-loc">Lokasi Perusahaan</label><input type="text" id="s-company-loc" required placeholder="Ex: Jakarta, Surabaya, dll" style="padding:10px; border-radius:8px; border:1px solid var(--border);" autocomplete="address-level2"></div>
                                    <div style="display:flex; flex-direction:column; gap:5px;"><label for="s-contact" style="font-weight:700; font-size:0.85rem;">Kontak Customer (Telp/WA)</label><input type="text" id="s-contact" placeholder="Contoh: 0812xxxx atau email@perusahaan.com" style="padding:10px; border-radius:8px; border:1px solid var(--border);" required></div>
                                    <div style="display:flex; flex-direction:column; gap:5px;"><label for="s-reg-sel" style="font-weight:700; font-size:0.85rem;">Regulasi (Ketik untuk cari)</label><input type="text" id="s-reg-sel" list="s-reg-list" placeholder="Cari regulasi..." required style="padding:10px; border-radius:8px; border:1px solid var(--border);"><datalist id="s-reg-list"><!-- Opsi diisi otomatis oleh updateMasterUI --></datalist></div>  
                            <legend style="font-weight:600; margin-bottom:10px; display:block;">Pilih Parameter & Metode:</legend>
                            <div id="param-check-container" style="display:grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap:10px; background:#f8fafc; padding:20px; border-radius:15px;"></div>
                        </fieldset>
                        <button type="submit" class="btn-primary" style="grid-column: 1/-1; padding:15px;">SIMPAN DATA SAMPEL</button>
                    </form>
                </section>
            </div>

            <!-- SECTION INPUT DATA SAMPLING -->
            <div id="view-input-sampling" class="section-container" style="display:none;">
                <section class="section-box">
                    <header style="margin-bottom: 20px;">
                        <h3>Input Data Lapangan / Sampling</h3>
                        <p style="font-size:0.8rem; color:var(--text-muted);">Lengkapi detail teknis pengambilan sampel di lapangan</p>
                    </header>
                    
                    <!-- Tambahkan Tag Form di sini -->
                    <form id="sampling-form" style="display:grid; grid-template-columns:repeat(auto-fit, minmax(250px,1fr)); gap:20px;">
                        
                        <div style="display:flex; flex-direction:column; gap:5px;">
                            <label for="samp-id-select" style="font-weight:700; font-size:0.85rem;">Pilih ID Sampel</label>
                            <select id="samp-id-select" required onchange="showSampleInfo(this.value)" style="padding:12px; border-radius:10px; border:1px solid var(--border); background:#f8fafc;"></select>
                            
                            <!-- Info Detail Otomatis -->
                            <div id="info-detail-sampel" style="margin-top:10px; padding:10px; background:#eef2ff; border-radius:8px; border:1px solid #e0e7ff; display:none;">
                                <div style="font-size:0.75rem; color:#4338ca;"><b>Regulasi:</b> <span id="info-reg">-</span></div>
                                <div style="font-size:0.75rem; color:#4338ca;"><b>O2 Regulasi:</b> <span id="info-o2-reg">-</span> %</div>
                                <div style="font-size:0.75rem; color:#4338ca;"><b>Parameter:</b> <span id="info-param">-</span></div>
                                <div style="font-size:0.75rem; color:#4338ca;"><b>Metode:</b> <span id="info-metode">-</span></div>
                                
                            </div>
                        </div>
                        
                        <div style="display:flex; flex-direction:column; gap:5px;">
                            <label for="samp-lokasi" style="font-weight:700; font-size:0.85rem;">Lokasi Sampling</label>
                            <input type="text" id="samp-lokasi" placeholder="Contoh: Cerobong 01" required style="padding:12px; border-radius:10px; border:1px solid var(--border);">
                        </div>

                        <div style="display:flex; flex-direction:column; gap:5px;">
                            <label for="samp-o2" style="font-weight:700; font-size:0.85rem;">O2 Terukur / Lapangan (%)</label>
                            <input type="number" id="samp-o2" placeholder="Contoh: 20.9" step="0.1" required style="padding:12px; border-radius:10px; border:1px solid var(--border);">
                        </div>

                        <div style="display:flex; flex-direction:column; gap:5px;">
                            <label for="samp-volume" style="font-weight:700; font-size:0.85rem;">Volume Sampling (mÂ³)</label>
                            <input type="number" id="samp-volume" placeholder="0.000" step="0.001" required style="padding:12px; border-radius:10px; border:1px solid var(--border);">
                        </div>

                        <div style="display:flex; flex-direction:column; gap:5px;">
                            <label style="font-weight:700; font-size:0.85rem;">Velocity (m/s)</label>
                            <input type="number" id="samp-velocity" step="0.01" placeholder="0.00" style="padding:12px; border-radius:10px; border:1px solid var(--border);">
                        </div>

                        <div style="display:flex; flex-direction:column; gap:5px;">
                            <label style="font-weight:700; font-size:0.85rem;">Volumetric Flow Rate (mÂ³/s)</label>
                            <input type="number" id="samp-flow" step="0.01" placeholder="0.00" style="padding:12px; border-radius:10px; border:1px solid var(--border);">
                        </div>

                        <div style="display:flex; flex-direction:column; gap:5px;">
                            <label style="font-weight:700; font-size:0.85rem;">Water Vapor (%)</label>
                            <input type="number" id="samp-water" step="0.01" placeholder="0.00" style="padding:12px; border-radius:10px; border:1px solid var(--border);">
                        </div>

                        <div style="display:flex; flex-direction:column; gap:5px;">
                            <label style="font-weight:700; font-size:0.85rem;">Num of Traverse Point</label>
                            <input type="number" id="samp-traverse" placeholder="0" style="padding:12px; border-radius:10px; border:1px solid var(--border);">
                        </div>

                        <div style="display:flex; flex-direction:column; gap:5px;">
                            <label style="font-weight:700; font-size:0.85rem;">Percent of Isokinetic (%)</label>
                            <input type="number" id="samp-isokinetic" step="0.01" placeholder="90 - 110" style="padding:12px; border-radius:10px; border:1px solid var(--border);">
                        </div>

                        <div style="display:flex; flex-direction:column; gap:5px;">
                            <label for="samp-date" style="font-weight:700; font-size:0.85rem;">Tanggal Sampling</label>
                            <input type="date" id="samp-date" required style="padding:12px; border-radius:10px; border:1px solid var(--border); background:#f8fafc;">
                        </div>

                        <div style="display:flex; flex-direction:column; gap:5px;">
                            <label for="samp-time" style="font-weight:700; font-size:0.85rem;">Waktu Sampling</label>
                            <input type="time" id="samp-time" required style="padding:12px; border-radius:10px; border:1px solid var(--border); background:#f8fafc;">
                        </div>

                        <div style="display:flex; flex-direction:column; gap:5px;">
                            <label for="samp-weather" style="font-weight:700; font-size:0.85rem;">Cuaca</label>
                            <select id="samp-weather" style="padding:12px; border-radius:10px; border:1px solid var(--border); background:#f8fafc;">
                                <option value="Cloudy">Berawan</option>
                                <option value="Partly cloudy">Cerah Berawan</option>
                                <option value="Heavy Rain">Hujan Badai</option>
                                <option value="Rain">Hujan</option>
                                <option value="Sunny">Cerah/Panas</option>
                            </select>
                        </div>

                        <div style="display:flex; flex-direction:column; gap:5px;">
                            <label for="samp-coord" style="font-weight:700; font-size:0.85rem;">Koordinat Sampling</label>
                            <input type="text" id="samp-coord" placeholder="Contoh: S 06Â°... E 106Â°..." style="padding:12px; border-radius:10px; border:1px solid var(--border); background:#f8fafc;">
                        </div>

                        <div style="grid-column: 1 / -1; display:flex; flex-direction:column; gap:5px;">
                            <label for="samp-note" style="font-weight:700; font-size:0.85rem;">Keterangan Tambahan</label>
                            <textarea id="samp-note" rows="3" placeholder="Kondisi cuaca atau catatan teknis lainnya..." style="padding:12px; border-radius:10px; border:1px solid var(--border); font-family:inherit;"></textarea>
                        </div>

                        <button type="submit" class="btn-primary" style="grid-column: 1 / -1; height:50px; font-weight:800; letter-spacing:1px;">SIMPAN DATA LAPANGAN</button>
                    </form>
                </section>
            </div>


            <!-- SECTION ANALISA -->
            <div id="view-analisa" class="section-container" style="display:none;">
                <section class="section-box" style="overflow-x: auto; padding: 20px; border-radius: 18px; background: white;">
                    <table class="lab-table" style="width: 100%; border-collapse: collapse; min-width: 1000px;">
                        <thead style="background: #f8fafc;">
                            <tr>
                                <th style="padding: 12px; width: 120px;">ID Sampel</th>
                                <th style="padding: 12px; width: 160px; text-transform: none;">Metode Analisis</th>
                                <th style="padding: 12px; width: 180px;">Parameter Uji</th>
                                <th style="padding: 12px; text-align: center; width: 180px;">Bobot Sampel (Awal/Akhir)</th>
                                <th style="padding: 12px; text-align: center; width: 180px;">Bobot Blanko (Awal/Akhir)</th>
                                <th style="padding: 12px; text-align: center; width: 100px; text-transform: none;">Oâ‚‚ Terukur</th>
                                <th style="padding: 12px; text-align: center; width: 160px;">Hasil</th>
                                <th style="padding: 12px; text-align: right; width: 120px;">Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="body-analisa" style="background: white;">
                        </tbody>
                    </table>
                </section>
            </div>

            <!-- SECTION HASIL -->
            <div id="view-coa" class="section-container" style="display:none;">
                <section class="section-box">
                    <div style="display:flex; justify-content:space-between; margin-bottom:20px;">
                        <h3>Laporan Data Hasil Analisa</h3>
                        <button onclick="exportExcel()" class="btn-primary" style="background:var(--success);">Export Excel</button>
                    </div>
                    <table class="lab-table">
                        <thead>
                            <tr>
                                <th>ID Sampel</th>
                                <th>Perusahaan</th>
                                <th>Regulasi</th>
                                <th>Parameter</th>
                                <th>Metode</th>
                                <th style="text-align: center;">Hasil</th>
                                <th>Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="body-coa"></tbody>
                    </table>
                </section>
            </div>
        </main>
    </div>

    <div id="toast-container" class="toast-container"></div>

    <script>

            let db = [];
            let cocDB = [];
            let logs = [];
            let recycleBin = [];
            let masterReg = [];
            let masterMap = {};

            let myChart;

            /*
            ==================================================
            LOAD LOCAL DATABASE SAFELY
            ==================================================
            */

            function loadLocalDB(){

                try{
                    db = JSON.parse(localStorage.getItem('lab_final_db')) || [];
                    cocDB = JSON.parse(localStorage.getItem("cocDB")) || [];
                    logs = JSON.parse(localStorage.getItem('lab_audit_logs')) || [];
                    recycleBin = JSON.parse(localStorage.getItem('lab_recycle_bin')) || [];
                    masterReg = JSON.parse(localStorage.getItem('lab_final_reg')) || [];
                    masterMap = JSON.parse(localStorage.getItem('lab_final_map')) || {};
                }
                catch(err){
                    console.error("Database corrupted, resetting...");
                    localStorage.clear();
                }

            }


            /*
            ==================================================
            WINDOW ON LOAD
            ==================================================
            */

            window.onload = () => {

                try {

                    loadLocalDB();

                    // Auth check
                    if (sessionStorage.getItem('isAuth') === 'true') {

                        const loginPage = document.getElementById('login-page');
                        const dashboard = document.getElementById('main-dashboard');

                        if(loginPage) loginPage.style.display = 'none';
                        if(dashboard) dashboard.style.display = 'flex';

                        const lastMenu =
                            sessionStorage.getItem('activeMenu') || 'view-home';

                        const menuBtn =
                            document.querySelector(`button[onclick*="${lastMenu}"]`);

                        if(menuBtn){
                            showSection(lastMenu, menuBtn);
                        }

                    }

                    updateStats();

                    // Live Date
                    const liveDate = document.getElementById('live-date');

                    if(liveDate){
                        liveDate.innerText =
                        new Date().toLocaleDateString('id-ID',{
                            weekday:'long',
                            day:'numeric',
                            month:'long',
                            year:'numeric'
                        });
                    }

                } catch(err){
                    console.error("Init error:", err);
                }

            };


        function bindCascadeDropdown(row, paramValue, methodValue){

            const paramSelect = row.querySelector(".param-select");
            const methodSelect = row.querySelector(".method-select");

            if(!paramSelect || !methodSelect) return;

            // Set value param
            paramSelect.value = paramValue || "";

            // Render method sesuai param
            methodSelect.innerHTML =
                generateMethodOptions(paramValue, methodValue);

            // Event listener param change (SAFE VERSION)
            paramSelect.onchange = function(){
                methodSelect.innerHTML =
                    generateMethodOptions(this.value, "");
            };
        }

        function searchCOC(){

            const keyword =
                document.getElementById("search-coc")
                ?.value.toLowerCase().trim() || "";

            const filtered = cocDB.filter(c =>
                (c.cocNo || "").toLowerCase().includes(keyword) ||
                (c.companyName || "").toLowerCase().includes(keyword)
            );

            renderCOCList(keyword ? filtered : cocDB);
        }

        function renderCOCList(data = cocDB) {

            const body = document.getElementById("coc-list-body");
            if (!body) return;

            body.innerHTML = "";

            if (!data || data.length === 0) {
                body.innerHTML = `
                    <tr>
                        <td colspan="5" style="text-align:center; padding:10px;">
                            Tidak ada data ditemukan
                        </td>
                    </tr>
                `;
                return;
            }

            data.forEach((coc, index) => {

                const row = body.insertRow();

                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${coc?.cocNo || "-"}</td>
                    <td>${coc?.companyName || "-"}</td>
                    <td>${coc?.planDate || "-"}</td>
                    <td>

                        <button
                            onclick="openCOCFromList('${coc.cocNo}')"
                            style="padding:4px 8px; margin-right:5px;">
                            Buka
                        </button>

                        <button
                            onclick="deleteCOCFromList('${coc.cocNo}')"
                            style="background:red;color:white;border:none;padding:4px 8px;">
                            Hapus
                        </button>

                    </td>
                `;
            });
        }

        function openCOCFromList(cocNo) {

            // pindah ke menu form COC
            const btn = document.querySelector("button[onclick*='view-coc']");
            showSection("view-coc", btn);

            loadCOC(cocNo);

            // set dropdown supaya ikut terpilih
            const select = document.getElementById("coc-select");
            if (select) select.value = cocNo;
        }

        function deleteCOCFromList(cocNo) {

            if (!confirm("Yakin hapus COC ini?")) return;

            cocDB = cocDB.filter(c => c.cocNo !== cocNo);

            localStorage.setItem("cocDB", JSON.stringify(cocDB));

            renderCOCList();
            renderCOC();

        }

        function newCOC() {

            // Reset semua input text & date
            document.querySelectorAll("#view-coc input").forEach(input => {
                input.value = "";
            });

            // Reset dropdown COC
            const select = document.getElementById("coc-select");
            if (select) select.value = "";

            // Kosongkan tabel sampel
            const body = document.getElementById("coc-samples-body");
            body.innerHTML = "";

            // Tambahkan 1 baris kosong
            addCOCRow();

        }

        function saveCOC() {

            const getVal = id => document.getElementById(id)?.value || "";

            if (!getVal("coc-coc-no")) {
                showToast("COC No wajib diisi!", "error");
                return;
            }

            const cocData = {
                companyName: getVal("coc-company-name"),
                companyAddress: getVal("coc-company-address"),
                email: getVal("coc-email-coa"),
                cocNo: getVal("coc-coc-no"),
                ltrNo: getVal("coc-ltr-no"),
                location: getVal("coc-company-location-detail"),
                tat: getVal("coc-tat-req"),
                officerA: getVal("coc-officer-a"),
                officerB: getVal("coc-officer-b"),
                officerC: getVal("coc-officer-c"),
                planDate: getVal("coc-plan-date"),
                pic: getVal("coc-pic"),
                phone: getVal("coc-phone-no"),
                samples: []
            };

            const rows = document.querySelectorAll("#coc-samples-body tr");

            rows.forEach(row => {

                const inputs = row.querySelectorAll("td input");

                const sampleId = inputs[0]?.value.trim();
                if (!sampleId) return; // skip kalau kosong

                const description = inputs[1]?.value || "";
                const matrix = inputs[2]?.value || "";
                const container = inputs[3]?.value || "";

                const regulation = row.querySelector(".reg-select")?.value || "";
                const parameter = row.querySelector(".param-select")?.value || "";
                const method = row.querySelector(".method-select")?.value || "";

                // ðŸ”Ž Cek apakah sampleId sudah ada
                let existingSample = cocData.samples.find(s => s.sampleId === sampleId);

                if (!existingSample) {
                    // Buat sample baru
                    existingSample = {
                        sampleId,
                        description,
                        matrix,
                        container,
                        regulation,
                        tests: []
                    };
                    cocData.samples.push(existingSample);
                }

                // Tambahkan test ke sample
                if (parameter) {
                    existingSample.tests.push({
                        parameter,
                        method
                    });
                }

            });

            const existingIndex = cocDB.findIndex(c => c.cocNo === cocData.cocNo);

            if (existingIndex !== -1) {
                cocDB[existingIndex] = cocData;
            } else {
                cocDB.push(cocData);
            }

            localStorage.setItem("cocDB", JSON.stringify(cocDB));

            showToast("COC berhasil disimpan!", "success");
            renderCOC();
        }
        

        function addCOCRow() {

            const body = document.getElementById("coc-samples-body");
            if (!body) return;

            const row = body.insertRow();
            const rowCount = body.rows.length;

            row.innerHTML = `
            
                <td style="border:1px solid #000; padding:5px;">${rowCount}</td>

                <td style="border:1px solid #000; padding:5px;">
                    <input type="text" style="width:100%; border:none;">
                </td>

                <td style="border:1px solid #000; padding:5px;">
                    <input type="text" style="width:100%; border:none;">
                </td>

                <td style="border:1px solid #000; padding:5px;">
                    <input type="text" style="width:100%; border:none;">
                </td>

                <td style="border:1px solid #000; padding:5px;">
                    <input type="text" style="width:100%; border:none;">
                </td>

                <!-- REGULASI -->
                <td style="border:1px solid #000; padding:5px; width:160px;">
                    <select class="reg-select" style="width:100%;">
                        ${generateRegOptions()}
                    </select>
                </td>

                <!-- PARAMETER -->
                <td style="border:1px solid #000; padding:5px; width:150px;">
                    <select class="param-select" style="width:100%;">
                        ${generateParamOptions()}
                    </select>
                </td>

                <!-- METODE -->
                <td style="border:1px solid #000; padding:5px; width:160px;">
                    <select class="method-select" style="width:100%;">
                        <option value="">-- Pilih Metode --</option>
                    </select>
                </td>

                <td style="border:1px solid #000; padding:5px; text-align:center;">
                    <button type="button"
                            onclick="deleteCOCRow(this)"
                            style="background:red; color:white; border:none; padding:3px 6px; cursor:pointer;">
                        âœ•
                    </button>
                </td>
            `;
            const paramSelect = row.querySelector(".param-select");
            const methodSelect = row.querySelector(".method-select");

            paramSelect.onchange = function(){
                methodSelect.innerHTML =
                    generateMethodOptions(this.value, "");
            };

            renumberCOCRows();
        }

        function generateRegOptions(selected = "") {

            let options = `<option value="">-- Pilih Regulasi --</option>`;

            masterReg.forEach(reg => {

                const isSelected = reg.name === selected ? "selected" : "";

                options += `
                    <option value="${reg.name}" ${isSelected}>
                        ${reg.name}
                    </option>
                `;
            });

            return options;
        }

        function generateMethodOptions(param, selected = "") {

            let options = `<option value="">-- Pilih Metode --</option>`;

            if (!masterMap[param]) return options;

            masterMap[param].forEach(method => {

                const isSelected = method === selected ? "selected" : "";

                options += `
                    <option value="${method}" ${isSelected}>
                        ${method}
                    </option>
                `;
            });

            return options;
        }

        function generateParamOptions(selected = "") {

            let options = `<option value="">-- Pilih Parameter --</option>`;

            Object.keys(masterMap).forEach(param => {

                const isSelected = param === selected ? "selected" : "";

                options += `
                    <option value="${param}" ${isSelected}>
                        ${param}
                    </option>
                `;
            });

            return options;
        }

        function updateMethod(selectElement) {

            const selectedParam = selectElement.value;

            const row = selectElement.closest("tr");
            const methodSelect = row.querySelector(".method-select");

            methodSelect.innerHTML = `<option value="">-- Pilih Metode --</option>`;

            if (!selectedParam || !masterMap[selectedParam]) return;

            masterMap[selectedParam].forEach(method => {

                methodSelect.innerHTML += `
                    <option value="${method}">
                        ${method}
                    </option>
                `;
            });
        }

        function deleteCOCRow(button) {
            const row = button.closest("tr");
            row.remove();
            renumberCOCRows();
        }

        function renumberCOCRows() {
            const rows = document.querySelectorAll("#coc-samples-body tr");
            rows.forEach((row, index) => {
                row.cells[0].innerText = index + 1;
            });
        }

        function renderCOC() {

            const select = document.getElementById("coc-select");
            if (!select) return;

            select.innerHTML =
                '<option value="">-- Pilih COC Tersimpan --</option>' +
                cocDB.map(c =>
                    `<option value="${c.cocNo}">${c.cocNo}</option>`
                ).join("");
        }

        function loadCOC(cocNo) {

            if (!cocNo) return;
            if (!cocDB || cocDB.length === 0) return;

            const data = cocDB.find(c => c.cocNo === cocNo);
            if (!data) return;

            // ===== HEADER =====
            const fields = {
                "coc-company-name": data.companyName,
                "coc-company-address": data.companyAddress,
                "coc-email-coa": data.email,
                "coc-coc-no": data.cocNo,
                "coc-ltr-no": data.ltrNo,
                "coc-company-location-detail": data.location,
                "coc-tat-req": data.tat,
                "coc-officer-a": data.officerA,
                "coc-officer-b": data.officerB,
                "coc-officer-c": data.officerC,
                "coc-plan-date": data.planDate,
                "coc-pic": data.pic,
                "coc-phone-no": data.phone
            };

            Object.entries(fields).forEach(([id, value]) => {
                const el = document.getElementById(id);
                if (el) el.value = value || "";
            });

            // ===== TABLE BODY =====
            const body = document.getElementById("coc-samples-body");
            if (!body) return;

            body.innerHTML = "";

            data.samples.forEach((s, index) => {

                s.tests.forEach(test => {

                    const row = body.insertRow();

                    row.innerHTML = `
                        <td style="border:1px solid #000;padding:5px">${body.rows.length}</td>

                        <td><input value="${s.sampleId}" style="width:100%;border:none"></td>
                        <td><input value="${s.description}" style="width:100%;border:none"></td>
                        <td><input value="${s.matrix}" style="width:100%;border:none"></td>
                        <td><input value="${s.container}" style="width:100%;border:none"></td>

                        <td>
                            <select class="reg-select" style="width:100%">
                                ${generateRegOptions(s.regulation)}
                            </select>
                        </td>

                        <td>
                            <select class="param-select" style="width:100%">
                                ${generateParamOptions(test.parameter)}
                            </select>
                        </td>

                        <td>
                            <select class="method-select" style="width:100%">
                                ${generateMethodOptions(test.parameter, test.method)}
                            </select>
                        </td>

                        <td style="text-align:center">
                            <button onclick="deleteCOCRow(this)"
                                style="background:red;color:white;border:none;padding:3px 6px">
                                âœ•
                            </button>
                        </td>
                    `;

                    const paramSelect = row.querySelector(".param-select");
                    const methodSelect = row.querySelector(".method-select");

                    paramSelect.onchange = function(){
                        methodSelect.innerHTML =
                            generateMethodOptions(this.value, "");
                    };

                });

            });

        }
        
        function deleteCOC(){

            const select = document.getElementById("coc-select");
            const cocNo = select.value;

            if(!cocNo){
                showToast("Pilih COC dulu","error");
                return;
            }

            if(!confirm("Hapus COC ini?")) return;

            cocDB = cocDB.filter(c => c.cocNo !== cocNo);

            localStorage.setItem("cocDB", JSON.stringify(cocDB));

            showToast("COC dihapus","success");

            const activeMenu = sessionStorage.getItem("activeMenu");

            if(activeMenu === "view-coc-list"){
                renderCOCList();
            }

            if(activeMenu === "view-coc"){
                renderCOC();
            }
        }

        function addLog(action, details) {
            // Ambil role tepat saat log dibuat
            const currentUser = sessionStorage.getItem('role') || 'Sistem'; 

            const newLog = {
                timestamp: new Date().toLocaleString('id-ID'),
                user: currentUser, // Menggunakan role yang sedang aktif
                action: action,
                details: details
            };
            
            logs.unshift(newLog);
            if(logs.length > 500) logs.pop(); 
            localStorage.setItem('lab_audit_logs', JSON.stringify(logs));
        }

       document.getElementById('login-form').addEventListener('submit', async (e) => {

            e.preventDefault();

            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value.trim();

            if (!username || !password) {
                showToast("Username dan Password wajib diisi!", "error");
                return;
            }

            try {

                if (!window.supabase) {
                    showToast("Supabase belum siap!", "error");
                    return;
                }

                const { data, error } = await supabase
                    .from('users')
                    .select('*')
                    .eq('username', username);

                if(error || !data || data.length === 0){
                    showToast("Login gagal!", "error");
                    return;
                }

                const user = data.find(u => u.password_hash === password);

                if(!user){
                    showToast("Login gagal! Password salah", "error");
                    return;
                }

                if (error || !data) {
                    showToast("Login gagal! Cek username/password", "error");
                    return;
                }

                // âœ… Session
                sessionStorage.setItem('isAuth', 'true');
                sessionStorage.setItem('role', data.role);
                sessionStorage.setItem('user', username);

                // âœ… Audit Log
                addLog("LOGIN", `User ${data.role} login ke sistem`);

                showToast("Login berhasil", "success");

                setTimeout(() => {
                    showDashboard();
                }, 500);

            } catch (err) {
                console.error(err);
                showToast("Terjadi kesalahan sistem", "error");
            }

        });

                    async function showDashboard(){

                        const loginPage = document.getElementById('login-page');
                        const dashboard = document.getElementById('main-dashboard');

                        if(loginPage) loginPage.style.display = 'none';
                        if(dashboard) dashboard.style.display = 'flex';

                        try {

                            const username = sessionStorage.getItem('user');

                            if(!username){
                                logout();
                                return;
                            }

                            const { data, error } = await supabase
                                .from('users')
                                .select('role')
                                .eq('username', username)
                                .single();

                            if(error || !data){
                                showToast("Session tidak valid", "error");
                                logout();
                                return;
                            }

                            const r = data.role.toUpperCase();

                            document.getElementById('m-logs').style.display =
                                r === "ADMIN" ? "block" : "none";

                            document.getElementById('m-recycle').style.display =
                                r === "ADMIN" ? "block" : "none";

                            document.getElementById('m-master').style.display =
                                r === "ADMIN" ? "block" : "none";

                            document.getElementById('m-sampel').style.display =
                                (r === "ADMIN" || r === "ANALIS" || r === "VALIDATOR")
                                ? "block"
                                : "none";

                            updateMasterUI();
                            renderTables();
                            updateStats();

                        } catch(err){
                            console.error(err);
                            showToast("Error memuat dashboard", "error");
                        }
                    }

                            const r = data.role.toUpperCase();

                            const isAdmin = r === 'ADMIN';
                            const isAnalyst = r === 'ANALIS';
                            const isValidator = r === 'VALIDATOR';

                            // MENU REFERENCES
                            const logMenu = document.getElementById('m-logs');
                            const binMenu = document.getElementById('m-recycle');
                            const cocMenu = document.getElementById('m-coc');
                            const masterMenu = document.getElementById('m-master');
                            const sampelMenu = document.getElementById('m-sampel');

                            if(cocMenu){
                                cocMenu.style.display =
                                    (isAdmin || isAnalyst || isValidator) ? 'block' : 'none';
                            }

                            if(logMenu){
                                logMenu.style.display = isAdmin ? 'block' : 'none';
                            }

                            if(binMenu){
                                binMenu.style.display = isAdmin ? 'block' : 'none';
                            }

                            if(masterMenu){
                                masterMenu.style.display = isAdmin ? 'block' : 'none';
                            }

                            if(sampelMenu){
                                sampelMenu.style.display =
                                    (isAdmin || isAnalyst || isValidator) ? 'block' : 'none';
                            }

                            updateMasterUI();
                            renderTables();
                            updateStats();

                        } catch(err){
                            console.error(err);
                            showToast("Error memuat dashboard", "error");
                        }
                    }

                    function logout(){
                        sessionStorage.clear();
                        location.reload();
                    }

                    function saveMaster() {
                        localStorage.setItem('lab_final_reg', JSON.stringify(masterReg));
                        localStorage.setItem('lab_final_map', JSON.stringify(masterMap));
                        updateMasterUI();
                        showToast("Master Data Disimpan");
                    }


        function addReg() {
            const name = document.getElementById('m-reg-in').value;
            const o2Val = document.getElementById('m-o2-in').value; // Input baru
            const limitVal = document.getElementById('m-limit-in').value; // Ambil nilai limit

            if(name && o2Val && limitVal) {
                masterReg.push({ name: name, o2: Number.parseFloat(o2Val),limit: limitVal });
                saveMaster();
                document.getElementById('m-reg-in').value = '';
                document.getElementById('m-o2-in').value = '';
                document.getElementById('m-limit-in').value = '';

                showToast("Regulasi & Baku Mutu Tersimpan");
            } else {
                showToast("Nama & O2 Koreksi harus diisi!", "error");
            }
        }

        function addMap() {
            const p = document.getElementById('m-param-in').value, m = document.getElementById('m-met-in').value;
            if(p && m){
                if(!masterMap[p]) masterMap[p] = [];
                if(!masterMap[p].includes(m)) masterMap[p].push(m);
                saveMaster(); document.getElementById('m-met-in').value='';
            }
        }

        function updateMasterUI() {
            // 1. Render List di halaman Master Data (Daftar Regulasi)
            const listReg = document.getElementById('list-reg');
            if (listReg) {
                listReg.innerHTML = masterReg.map((r, i) => `
                    <li style="display:flex; justify-content:space-between; align-items:center; padding:10px; border-bottom:1px solid #eee;">
                        <span>${r.name} <strong>(${r.o2}%)</strong></span>
                        <button type="button" onclick="masterReg.splice(${i},1); saveMaster();" style="background:none; border:none; color:var(--danger); cursor:pointer;">
                            <i class="fas fa-trash"></i>
                        </button>
                    </li>`).join('');
            }

            // 2. Update Datalist (Fitur Search) untuk Penerimaan Sampel
            const sRegList = document.getElementById('s-reg-list');
            if (sRegList) {
                sRegList.innerHTML = masterReg.map(r => 
                    `<option value="${r.name}"> (Ref O2: ${r.o2}%)</option>`
                ).join('');
            }

            // 3. Render Mapping Parameter (Master Data)
            let mapHtml = '';
            for(let p in masterMap) {
                mapHtml += `
                <div style="background:#f8fafc; padding:12px; border-radius:12px; margin-bottom:10px; border:1px solid #eee;">
                    <div style="display:flex; justify-content:space-between;">
                        <strong>${p}</strong> 
                        <i class="fas fa-trash" onclick="delete masterMap['${p}']; saveMaster();" style="color:var(--danger); cursor:pointer; font-size:0.8rem;"></i>
                    </div>
                    ${masterMap[p].map((m,i) => `
                        <div style="font-size:0.75rem; color:#666; display:flex; justify-content:space-between; margin-top:3px;">
                            - ${m} 
                            <i class="fas fa-times" onclick="masterMap['${p}'].splice(${i},1); saveMaster();" style="color:var(--danger); cursor:pointer;"></i>
                        </div>`).join('')}
                </div>`;
            }
            const listMapping = document.getElementById('list-mapping');
            if(listMapping) listMapping.innerHTML = mapHtml || 'Belum ada mapping parameter.';

            // 4. Update Checkbox Parameter di Penerimaan Sampel (DENGAN ID & NAME UNTUK FIX ERROR BROWSER)
            const paramCheckContainer = document.getElementById('param-check-container');
            if(paramCheckContainer) {
                let checkHtml = '';
                for(let p in masterMap) {
                    checkHtml += `
                        <div style="background:white; padding:10px; border-radius:10px; display:flex; align-items:center; justify-content:space-between; border:1px solid #eee;">
                            <label style="font-size:0.85rem; cursor:pointer;" for="p-check-${p}">
                                <input type="checkbox" id="p-check-${p}" name="p-check" value="${p}" autocomplete="off"> ${p}
                            </label>
                            <select id="m-select-${p}" name="m-select-${p}" autocomplete="off" style="font-size:0.7rem; padding:4px;">
                                ${masterMap[p].map(m => `<option value="${m}">${m}</option>`).join('')}
                            </select>
                        </div>`;
                }
                paramCheckContainer.innerHTML = checkHtml;
            }
}

        document.getElementById('sample-form').addEventListener('submit', function(e) {
            e.preventDefault();
            
            // Ambil nilai dari input search regulasi
            const regValue = document.getElementById('s-reg-sel').value;

            // VALIDASI: Pastikan regulasi yang diketik ada di Master
            const isValidReg = masterReg.find(r => r.name === regValue);
            if(!isValidReg) {
                showToast("Regulasi tidak ditemukan! Pilih dari daftar.", "error");
                return;
            }

            const sid = document.getElementById('s-id').value;
            const comp = document.getElementById('s-company').value;
            // --- BARIS BARU: Ambil lokasi perusahaan ---
            const compLoc = document.getElementById('s-company-loc').value;
            const contact = document.getElementById('s-contact').value; 
            // --- AKHIR BARIS BARU ---
            const selectedParams = Array.from(document.querySelectorAll('input[name="p-check"]:checked'));
            
            if(!selectedParams.length) return showToast("Pilih Parameter!", "error");

            selectedParams.forEach(cb => {
                const p = cb.value;
                const m = document.querySelector(`select[name="m-select-${p}"]`).value;
                
                db.push({ 
                    id: sid, 
                    company: comp, 
                    // --- PROPERTI BARU: Simpan lokasi ke database ---
                    companyLocation: compLoc,
                    customerContact: contact, 
                    // --- AKHIR PROPERTI BARU ---
                    reg: regValue, 
                    param: p, met: m, res: '0.0000', isV: false, 
                    date: new Date().toLocaleDateString('id-ID'),
                    samplingData: null 
                });
            });

            localStorage.setItem('lab_final_db', JSON.stringify(db));
            this.reset();
            renderTables();
            updateStats();
            showToast("Sampel Berhasil Disimpan!");
        });

        function showSection(id, el){

            // ðŸ”¥ Sembunyikan SEMUA section (semua class section)
            document.querySelectorAll('.section-container, .content-section')
                .forEach(v => v.style.display = 'none');

            // Tampilkan section yang dipilih
            const target = document.getElementById(id);
            if(target) target.style.display = 'block';

            // Reset menu active
            document.querySelectorAll('.menu-link')
                .forEach(l => l.classList.remove('active'));

            if(el) el.classList.add('active');

            // Update title
            document.getElementById('view-title').innerText =
                el ? el.innerText.trim() : "Dashboard";

            // Save last menu
            sessionStorage.setItem('activeMenu', id);

            // Lazy Render
            if(id === 'view-coc-list'){
                renderCOCList();
            }

            if(id === 'view-coc'){
                renderCOC();
            }

            if(id === 'view-input-sampling'){
                updateSamplingDropdown?.();
            }
        }

        function renderLogs() {
            const bL = document.getElementById('body-logs');
            if (!bL) return;

            if (logs.length === 0) {
                bL.innerHTML = `<tr><td colspan="4" style="text-align:center; padding:20px; color:var(--text-muted);">Belum ada riwayat aktivitas.</td></tr>`;
                return;
            }

            bL.innerHTML = logs.map(l => {
                // Beri warna berbeda untuk setiap aksi
                let actionColor = '#64748b'; // Default abu-abu
                if (l.action === 'DELETE') actionColor = 'var(--danger)';
                if (l.action === 'VERIFY') actionColor = 'var(--success)';
                if (l.action === 'EDIT DATA') actionColor = 'var(--warning)';

                return `
                    <tr style="border-bottom: 1px solid #f1f5f9;">
                        <td style="font-size: 0.75rem; color: var(--text-muted);">${l.timestamp}</td>
                        <td><span style="font-weight: 700; color: var(--text-main);">${l.user}</span></td>
                        <td>
                            <span style="background: ${actionColor}; color: white; padding: 3px 8px; border-radius: 5px; font-size: 0.65rem; font-weight: 800;">
                                ${l.action}
                            </span>
                        </td>
                        <td style="font-size: 0.8rem; color: var(--text-main);">${l.details}</td>
                    </tr>
                `;
            }).join('');
        }

        function renderLogbookRow(bL, it) {
            if (bL && !it.isV) {
                bL.innerHTML += `
                    <tr style="border-bottom: 1px solid #f1f5f9;">
                        <td><small>${it.date}</small></td>
                        <td style="font-weight:700; color:var(--primary);">${it.id}</td>
                        <td>${it.company}</td>
                        <td><span style="background:#f1f5f9; padding:3px 7px; border-radius:5px; font-size:0.75rem;">${it.param}</span></td>
                        <td>
                            <span style="color:${it.res ? 'var(--warning)' : '#64748b'}; font-size:0.7rem; font-weight:800;">
                                <i class="fas fa-spinner"></i> ${it.res ? 'PROSES ANALISA' : 'MENUNGGU'}
                            </span>
                        </td>
                    </tr>`;
            }
        }

        function showSampleInfo(selectedId) {
            const infoBox = document.getElementById('info-detail-sampel');
            
            // JIKA TIDAK ADA ID YANG DIPILIH (Pilihan Kosong)
            if (!selectedId) {
                if(infoBox) infoBox.style.display = 'none';
                resetSamplingForm(); // Panggil fungsi reset di sini
                return;
            }

            const it = db.find(s => s.id === selectedId);

            if (it) {
                infoBox.style.display = 'block';
                const regData = masterReg.find(r => r.name === it.reg);
                const o2Nilai = regData ? regData.o2 : "0";

                infoBox.innerHTML = `
                    <div style="margin-bottom: 12px; padding-bottom: 8px; border-bottom: 1px solid #dee2e6;">
                        <div style="font-size: 0.85rem; color: #1e293b; margin-bottom: 4px;">
                            <i class="fas fa-building" style="color:var(--primary);"></i> <b>Perusahaan:</b> ${it.company}
                        </div>
                        <div style="font-size: 0.7rem; color: #64748b;">
                            <i class="fas fa-calendar-alt"></i> <b>Diterima:</b> ${it.date}
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                        <div style="font-size: 0.75rem; color: #4338ca;"><b>Regulasi:</b><br><span style="color: #1e293b;">${it.reg}</span></div>
                        <div style="font-size: 0.75rem; color: #4338ca;"><b>Oâ‚‚ Regulasi:</b><br><span style="color: #1e293b; font-weight: 700;">${o2Nilai} %</span></div>
                        <div style="font-size: 0.75rem; color: #4338ca;"><b>Parameter:</b><br><span style="color: #1e293b;">${it.param}</span></div>
                        <div style="font-size: 0.75rem; color: #4338ca;"><b>Metode:</b><br><span style="color: #1e293b;">${it.met}</span></div>
                    </div>
                `;

                if(it.samplingData) {
                    // --- JIKA DATA ADA (DITEMUKAN) ---
                    document.getElementById('samp-weather').value = it.samplingData.cuaca || 'Sunny';
                    document.getElementById('samp-coord').value = it.samplingData.koordinat || '';
                    document.getElementById('samp-date').value = it.samplingData.tgl || '';
                    document.getElementById('samp-time').value = it.samplingData.jam || '';
                    document.getElementById('samp-lokasi').value = it.samplingData.lokasi || '';
                    document.getElementById('samp-o2').value = it.samplingData.o2_lapangan || '';
                    document.getElementById('samp-volume').value = it.samplingData.volume || '';
                    document.getElementById('samp-velocity').value = it.samplingData.velocity || '';
                    document.getElementById('samp-flow').value = it.samplingData.flowRate || '';
                    document.getElementById('samp-water').value = it.samplingData.waterVapor || '';
                    document.getElementById('samp-traverse').value = it.samplingData.traversePoint || '';
                    document.getElementById('samp-isokinetic').value = it.samplingData.isokinetic || '';
                    document.getElementById('samp-note').value = it.samplingData.note || '';
                } else {
                    // --- JIKA DATA BARU (SET KE DEFAULT) ---
                    resetSamplingForm(); 
                }
            } else {
                // JIKA ID TIDAK DITEMUKAN DI DB
                infoBox.style.display = 'none';
                resetSamplingForm();
            }
        }

        function resetSamplingForm() {
            const form = document.getElementById('sampling-form');
            if (form) {
                form.reset(); 
                // Set nilai default manual yang tidak bisa di-reset form biasa
                document.getElementById('samp-weather').value = 'Sunny';
                document.getElementById('samp-o2').value = '';
                document.getElementById('samp-coord').value = 'S : 06Â°\'.0" E : 107Â°\'.0"';
                document.getElementById('samp-note').value = '-';
            }
        }

        function getVerifyButtonHtml(originalIndex, isVerified, canVerify) {
            const verifyButtonHtml = `<button onclick="toggleV(${originalIndex})" 
                style="background: var(--primary); color: white; border: none; padding: 8px 15px; border-radius: 8px; cursor: pointer; font-size: 0.7rem; font-weight: 800; letter-spacing: 0.5px;">
                <i class="fas fa-check-double"></i> VERIFY
            </button>`;
            
            const verifiedStatusHtml = `<div style="display: flex; align-items: center; gap: 6px;">
                <span style="background: #ecfdf5; color: #065f46; padding: 7px 12px; border-radius: 8px; font-size: 0.7rem; font-weight: 900; border: 1px solid #bbf7d0; display: flex; align-items: center; gap: 5px;">
                    <i class="fas fa-check-circle"></i> VERIFIED
                </span>
                <button onclick="toggleV(${originalIndex})" 
                    title="Unverify Data"
                    style="background: #fef3c7; color: #92400e; border: 1px solid #fde68a; padding: 7px 10px; border-radius: 8px; cursor: pointer; font-size: 0.65rem; font-weight: 800; display: flex; align-items: center; gap: 4px;">
                    <i class="fas fa-undo"></i> UNVERIFY
                </button>
            </div>`;
            
            if (canVerify) {
                return isVerified ? verifiedStatusHtml : verifyButtonHtml;
            }
            return isVerified ? '<span style="color:var(--success); font-weight:900; font-size:0.75rem; letter-spacing:1px;"><i class="fas fa-lock"></i> VERIFIED</span>' : '';
        }

        function buildPartikulatCell(originalIndex, it, vol) {
            const disabled = it.isV ? 'disabled' : '';
            return `
                <div style="display:flex; flex-direction:column; gap:5px; align-items:flex-start;">
                    <!-- Bobot Sampel Awal -->
                    <div style="display:flex; align-items:center; gap:4px;">
                        <input type="number" step="0.0001" value="${it.p_awal || ''}" 
                            placeholder="Awal"
                            onfocus="this.oldValue = this.value"
                            onchange="processWeightChange(${originalIndex}, 'p_awal', 'Bobot Awal', this, ${vol})" 
                            ${disabled} 
                            style="width:85px; font-size:0.75rem; padding:4px; border:1px solid var(--border); border-radius:4px; outline:none;"> 
                        <span style="font-size:0.65rem; font-weight:700; color:var(--text-muted);">gram</span>
                    </div>

                    <!-- Bobot Sampel Akhir -->
                    <div style="display:flex; align-items:center; gap:4px;">
                        <input type="number" step="0.0001" value="${it.p_akhir || ''}" 
                            placeholder="Akhir"
                            onfocus="this.oldValue = this.value"
                            onchange="processWeightChange(${originalIndex}, 'p_akhir', 'Bobot Akhir', this, ${vol})" 
                            ${disabled} 
                            style="width:85px; font-size:0.75rem; padding:4px; border:1px solid var(--border); border-radius:4px; outline:none;"> 
                        <span style="font-size:0.65rem; font-weight:700; color:var(--text-muted);">gram</span>
                    </div>
                </div>`;
        }

        function buildBlankoCell(originalIndex, it, vol) {
            const disabled = it.isV ? 'disabled' : '';
            return `
                <div style="display:flex; flex-direction:column; gap:5px; align-items:flex-start;">
                    <!-- Bobot Blanko Awal -->
                    <div style="display:flex; align-items:center; gap:4px;">
                        <input type="number" step="0.0001" value="${it.b_awal || ''}" 
                            placeholder="Awal"
                            onfocus="this.oldValue = this.value"
                            onchange="processWeightChange(${originalIndex}, 'b_awal', 'Bobot Blanko Awal', this, ${vol})" 
                            ${disabled} style="width:85px; font-size:0.75rem; padding:4px; border:1px solid var(--border); border-radius:4px;"> 
                        <span style="font-size:0.65rem; font-weight:700; color:var(--text-muted);">gram</span>
                    </div>

                    <!-- Bobot Blanko Akhir -->
                    <div style="display:flex; align-items:center; gap:4px;">
                        <input type="number" step="0.0001" value="${it.b_akhir || ''}" 
                            placeholder="Akhir"
                            onfocus="this.oldValue = this.value"
                            onchange="processWeightChange(${originalIndex}, 'b_akhir', 'Bobot Blanko Akhir', this, ${vol})" 
                            ${disabled} style="width:85px; font-size:0.75rem; padding:4px; border:1px solid var(--border); border-radius:4px;"> 
                        <span style="font-size:0.65rem; font-weight:700; color:var(--text-muted);">gram</span>
                    </div>
                </div>`;
        }

        function buildActionCell(originalIndex, it, canVerify, isAdmin) {
            const buttonBgColor = it.isV ? 'var(--warning)' : 'var(--primary)';
            const buttonLabel = it.isV ? '<i class="fas fa-undo"></i> UNVERIFY' : '<i class="fas fa-check"></i> VERIFY';
            
            let html = '<div style="display: flex; align-items: center; justify-content: flex-end; gap: 8px;">';
            
            // Tombol Verify/Unverify untuk Validator/Admin
            if (canVerify) {
                html += `<button onclick="toggleV(${originalIndex})" style="background: ${buttonBgColor}; color: white; border: none; padding: 6px 12px; border-radius: 8px; cursor: pointer; font-size: 0.65rem; font-weight: 800; min-width: 80px;">${buttonLabel}</button>`;
            }
            
            // Ikon Hapus KHUSUS Admin
            if (isAdmin) {
                html += `<i class="fas fa-trash-alt" onclick="deleteAnalisa(${originalIndex})" 
                        style="color:var(--danger); cursor:pointer; margin-left:10px; font-size: 1rem;" 
                        title="Hapus Data"></i>`;
            }
            
            html += '</div>';
            return html;
        }

        function renderAnalisaRow(bA, it, originalIndex, vol, isAnalis, canVerify, isAdmin) {
            if (isAnalis && it.isV) return; 

            const regData = masterReg.find(r => r.name === it.reg);
            const o2Koreksi = regData ? regData.o2 : 0;
            
            const partikulatCell = buildPartikulatCell(originalIndex, it, vol);
            const blankoCell = buildBlankoCell(originalIndex, it, vol);
            
            // Logika Aksi (Tombol)
            const buttonBgColor = it.isV ? 'var(--warning)' : 'var(--primary)';
            const buttonLabel = it.isV ? '<i class="fas fa-undo"></i>' : '<i class="fas fa-check"></i> Verify';
            
            let actionCell = `<div style="display: flex; align-items: center; justify-content: flex-end; gap: 8px;">`;
            if (canVerify) {
                actionCell += `<button onclick="toggleV(${originalIndex})" style="background: ${buttonBgColor}; color: white; border: none; padding: 6px 12px; border-radius: 8px; cursor: pointer; font-size: 0.65rem; font-weight: 800; min-width: 80px;">${buttonLabel}</button>`;
            }
            if (isAdmin) {
                actionCell += `<i class="fas fa-trash-alt" onclick="deleteAnalisa(${originalIndex})" style="color:var(--danger); cursor:pointer; font-size: 1rem; margin-left:5px;" title="Hapus"></i>`;
            }
            actionCell += `</div>`;

            bA.innerHTML += `
                <tr style="border-bottom: 1px solid #f1f5f9; text-transform: none;">
                    <!-- ID Sampel -->
                    <td style="padding: 12px; font-weight: 800; color: var(--primary); font-size: 0.85rem; text-transform: none;">${it.id}</td>
                    
                    <!-- Metode Analisis (Ditambahkan Sebelum Parameter) -->
                    <td style="padding: 12px; font-size: 0.75rem; color: var(--text-muted); font-weight: 600; text-transform: none;">
                        ${it.met || '-'}
                    </td>

                    <!-- Parameter Uji -->
                    <td style="padding: 12px; font-size: 0.8rem; line-height: 1.4; text-transform: none;">
                        <span style="font-weight: 700;">${it.param}</span><br>
                        <small style="color:var(--text-muted);">Vol: ${vol} mÂ³ | Ref Oâ‚‚: ${o2Koreksi}%</small>
                    </td>
                    
                    <!-- Input Partikulat -->
                    <td style="padding: 12px; text-align: center;">${partikulatCell}</td>
                    
                    <!-- Input Blanko -->
                    <td style="padding: 12px; text-align: center;">${blankoCell}</td>
                    
                    <!-- O2 Terukur -->
                    <td style="padding: 12px; text-align: center;">
                        <span style="font-weight: 900; color: #c2410c; font-size:0.85rem; background:#fff7ed; padding:4px 8px; border-radius:6px; border:1px solid #ffedd5;">
                            ${it.samplingData?.o2_lapangan || '20.9'}%
                        </span>
                    </td>
                    
                    <!-- Hasil -->
                    <td style="padding: 12px; text-align: center;">
                        <div style="display: flex; align-items: center; justify-content: center; gap: 5px;">
                            <div id="res-display-${originalIndex}" style="font-weight: 900; color: #166534; background: #f0fdf4; border: 1px solid #bbf7d0; padding: 6px 10px; border-radius: 8px; min-width: 75px; font-size: 0.9rem;">
                                ${it.res || '0.0000'}
                            </div>
                            <span style="font-size: 0.6rem; font-weight: 700; color: var(--text-muted); line-height:1;">mg/NmÂ³</span>
                        </div>
                    </td>
                    
                    <!-- Aksi -->
                    <td style="padding: 12px 20px; text-align: right;">
                        ${actionCell}
                    </td>
                </tr>`;
        }

        function renderCoaRow(bC, it, originalIndex, isAdmin, canVerify) {
            if(it.isV) {
                // Badge Hasil Terverifikasi
                const verifiedBadge = `
                    <div style="background: #ecfdf5; color: #065f46; padding: 6px 12px; border-radius: 8px; font-weight: 800; border: 1px solid #bbf7d0; display: inline-block; min-width: 80px;">
                        ${it.res} <small style="font-size: 0.65rem; font-weight: 600;">mg/NmÂ³</small>
                    </div>`;

                bC.innerHTML += `
                    <tr style="border-bottom: 1px solid #f1f5f9; font-size: 0.85rem; transition: background 0.2s;" onmouseover="this.style.background='#f8fafc'" onmouseout="this.style.background='transparent'">
                        <!-- ID Sampel -->
                        <td style="font-weight: 700; color: var(--primary); padding: 15px;">${it.id}</td>
                        
                        <!-- Perusahaan -->
                        <td style="font-weight: 600;">${it.company}</td>
                        
                        <!-- Regulasi -->
                        <td><small style="color: #64748b;">${it.reg}</small></td>
                        
                        <!-- Parameter -->
                        <td><span style="background: #f1f5f9; padding: 4px 8px; border-radius: 6px; font-weight: 700; color: #334155;">${it.param}</span></td>
                        
                        <!-- Metode (Menambahkan kolom yang tadi ada di header) -->
                        <td style="color: #64748b; font-size: 0.8rem;">${it.met}</td>
                        
                        <!-- Hasil (Center sesuai header) -->
                        <td style="text-align: center; padding: 10px;">${verifiedBadge}</td>
                        
                        <!-- Aksi -->
                        <td style="text-align: right; padding: 10px; white-space: nowrap;">
                            <div style="display: flex; align-items: center; justify-content: flex-end; gap: 8px;">
                                
                                ${canVerify ? `
                                    <button onclick="toggleV(${originalIndex})" 
                                        style="background: var(--warning); color: white; border: none; padding: 7px 12px; border-radius: 6px; cursor: pointer; font-size: 0.65rem; font-weight: 800; display: flex; align-items: center; gap: 5px;"
                                        title="Batalkan Verifikasi">
                                        <i class="fas fa-undo"></i> UNVERIFY
                                    </button>` : ''}

                                <button onclick="printCOA(${originalIndex})" 
                                    style="background: var(--primary); color: white; border: none; padding: 7px 12px; border-radius: 6px; cursor: pointer; font-size: 0.65rem; font-weight: 800; display: flex; align-items: center; gap: 5px;">
                                    <i class="fas fa-file-pdf"></i> PDF
                                </button>
                                
                                ${isAdmin ? `
                                    <button onclick="deleteAnalisa(${originalIndex})" 
                                        style="background: none; border: none; color: var(--danger); cursor: pointer; padding: 5px;" 
                                        title="Hapus Data">
                                        <i class="fas fa-trash-alt" style="font-size: 1.1rem;"></i>
                                    </button>` : ''}
                            </div>
                        </td>
                    </tr>`;
            }
        }

        function renderTables() {

            db = JSON.parse(localStorage.getItem('lab_final_db')) || [];

            const role = (sessionStorage.getItem('role') || "").toUpperCase();

            const bA = document.getElementById('body-analisa');
            const bL = document.getElementById('body-logbook');
            const bC = document.getElementById('body-coa');

            // Reset tabel
            if(bA) bA.innerHTML = '';
            if(bL) bL.innerHTML = '';
            if(bC) bC.innerHTML = '';

            const isAdmin = role === 'ADMIN';
            const isAnalis = role === 'ANALIS';
            const canVerify = role === 'ADMIN' || role === 'VALIDATOR';

            if(!db || db.length === 0){
                return;
            }

            db.forEach((it, originalIndex) => {

                const vol = (it.samplingData && it.samplingData.volume > 0)
                    ? parseFloat(it.samplingData.volume)
                    : 1;

                // Logbook
                if(bL) renderLogbookRow(bL, it);

                // Analisa
                if(bA) renderAnalisaRow(
                    bA,
                    it,
                    originalIndex,
                    vol,
                    isAnalis,
                    canVerify,
                    isAdmin
                );

                // COA (Hanya jika sudah verified)
                if(bC && it.isV){
                    renderCoaRow(bC, it, originalIndex, isAdmin, canVerify);
                }

            });

            updateSamplingDropdown();
            updateStats();
        }

        function hitungTotalPartikulat(idx, vol) {
            const it = db[idx];
            
            const pAwl = Number.parseFloat(it.p_awal) || 0;
            const pAkh = Number.parseFloat(it.p_akhir) || 0;
            const bAwl = Number.parseFloat(it.b_awal) || 0;
            const bAkh = Number.parseFloat(it.b_akhir) || 0;

            // --- VALIDASI QC: Bobot Akhir tidak boleh lebih kecil dari Awal ---
            const display = document.getElementById(`res-display-${idx}`);
            
            if (pAkh > 0 && pAkh < pAwl) {
                showToast("QC Alert: Bobot Sampel Akhir < Awal!", "error");
                if(display) {
                    display.innerText = "ERR-QC";
                    display.style.background = "#fee2e2"; // Warna merah muda
                    display.style.color = "#b91c1c";
                }
                return; 
            }

            if (bAkh > 0 && bAkh < bAwl) {
                showToast("QC Alert: Bobot Blanko Akhir < Awal!", "error");
                // Kita tetap lanjut tapi beri peringatan, atau bisa return seperti di atas
            }

            // --- PROSES KALKULASI (gram ke mg) ---
            const regData = masterReg.find(r => r.name === it.reg);
            const o2Koreksi = regData ? Number.parseFloat(regData.o2) : 0;
            const o2Terukur = Number.parseFloat(it.samplingData?.o2_lapangan) || 20.9;

            const netoGram = (pAkh - pAwl) - (bAkh - bAwl);
            const netoMiligram = netoGram * 1000; 

            let hasil = netoMiligram / vol;

            // Terapkan Rumus Koreksi O2
            if (o2Koreksi > 0 && o2Terukur < 20.9) {
                hasil = hasil * (20.9 - o2Koreksi) / (20.9 - o2Terukur);
            }

            // Update Database & UI
            it.res = hasil.toFixed(4);
            localStorage.setItem('lab_final_db', JSON.stringify(db));
            
            if (pAkh > 0) {
                    addLog("EDIT DATA", `Update bobot ID: ${it.id} | Parameter: ${it.param}`);
                }

            if(display) {
                display.innerText = it.res;
                display.style.background = "#f0fdf4"; // Kembali ke hijau normal
                display.style.color = "#166534";
            }
        }

        function updateSamplingDropdown() {
            const select = document.getElementById('samp-id-select');
            if(!select) return;

            // 1. Ambil ID Unik yang BELUM diverifikasi
            const uniqueIds = [...new Set(db.filter(i => !i.isV).map(item => item.id))];
            
            if (uniqueIds.length > 0) {
                // Jika ada sampel, tampilkan pilihan
                select.innerHTML = '<option value="">-- Pilih ID Sampel --</option>' + 
                    uniqueIds.map(id => `<option value="${id}">${id}</option>`).join('');
            } else {
                // 2. JIKA KOSONG: Tampilkan pesan & Bersihkan Form
                select.innerHTML = '<option value="">Tidak ada sampel aktif</option>';
                
                // Sembunyikan box info
                const infoBox = document.getElementById('info-detail-sampel');
                if(infoBox) infoBox.style.display = 'none';

                // Panggil fungsi reset form
                resetSamplingForm();
            }
        }

        function resetSamplingForm() {
            const form = document.getElementById('sampling-form');
            if (form) {
                form.reset(); // Mengosongkan semua input standar
                
                // Kembalikan nilai default yang spesifik
                if(document.getElementById('samp-o2')) document.getElementById('samp-o2').value = '';
                if(document.getElementById('samp-weather')) document.getElementById('samp-weather').value = 'Sunny';
                if(document.getElementById('samp-coord')) document.getElementById('samp-coord').value = 'S : 06Â°\'.0" E : 107Â°\'.0"';
            }
        }


        document.getElementById('sampling-form').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const selectedId = document.getElementById('samp-id-select').value;
            if(!selectedId) return showToast("Pilih ID Sampel!", "error");

            // Di dalam event listener submit sampling-form
            const samplingData = {
                tgl: document.getElementById('samp-date').value,
                jam: document.getElementById('samp-time').value,
                cuaca: document.getElementById('samp-weather').value, // Baru
                koordinat: document.getElementById('samp-coord').value, // Baru
                lokasi: document.getElementById('samp-lokasi').value,
                volume: Number.parseFloat(document.getElementById('samp-volume').value) || 1,
                velocity: document.getElementById('samp-velocity').value,
                flowRate: document.getElementById('samp-flow').value,
                waterVapor: document.getElementById('samp-water').value,
                traversePoint: document.getElementById('samp-traverse').value,
                isokinetic: document.getElementById('samp-isokinetic').value,
                o2_lapangan: Number.parseFloat(document.getElementById('samp-o2').value) || 20.9,
                note: document.getElementById('samp-note').value
            };


            db.forEach((item, index) => {
                if(item.id === selectedId) {
                    db[index].samplingData = samplingData;
                    if(db[index].p_awal && db[index].p_akhir) {
                        hitungTotalPartikulat(index, samplingData.volume);
                    }
                }
            });
            
            localStorage.setItem('lab_final_db', JSON.stringify(db));
            showToast(`Data lapangan ${selectedId} berhasil disimpan!`, "success");
            renderTables();
            updateStats();
        });

        function toggleV(i) {
            const it = db[i];
            const isNowVerifying = !it.isV; // Cek aksi: Mau verifikasi atau batal
            const actionName = isNowVerifying ? "VERIFIKASI" : "UNVERIFY";
            
            // 1. Pesan Peringatan Dinamis
            const message = isNowVerifying 
                ? `Apakah Anda yakin ingin MEMVERIFIKASI Sampel ID: ${it.id}? \nData akan dikunci dan siap untuk diterbitkan CoA.`
                : `âš ï¸ PERINGATAN: Anda akan membatalkan verifikasi Sampel ID: ${it.id}. \nData akan dapat diedit kembali oleh Analis. Lanjutkan?`;

            // 2. Munculkan Konfirmasi
            if (confirm(message)) {
                // Simpan Status Sebelum Berubah untuk Log
                const role = sessionStorage.getItem('role') || 'Unknown';
                
                // 3. Catat ke Audit Log
                addLog(actionName, `${actionName} pada ID: ${it.id} | Parameter: ${it.param}`);

                // 4. Update Status di Database
                db[i].isV = isNowVerifying;
                localStorage.setItem('lab_final_db', JSON.stringify(db));
                
                // 5. Refresh UI & Notifikasi
                renderTables(); 
                updateStats();
                
                const toastMsg = isNowVerifying ? "Data Berhasil Diverifikasi" : "Verifikasi Dibatalkan";
                showToast(toastMsg, isNowVerifying ? "success" : "warning");
            }
        }

        function updateChart(masuk, proses, selesai) {
            const chartEl = document.getElementById('labChart');
            if(!chartEl) return;
            
            const ctx = chartEl.getContext('2d');
            if(window.myChart) window.myChart.destroy(); 
            
            window.myChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ["Total Masuk", "Analisa", "Selesai"], // Label disesuaikan
                    datasets: [{
                        data: [masuk, proses, selesai],
                        backgroundColor: ['#4a90e2', '#f39c12', '#10b981'],
                        borderRadius: 5
                    }]
                },
                options: { 
                    responsive: true, 
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } }
                }
            });
        }

            function printCOA(idx) {
                const it = db[idx];
                if (!it) return showToast("Data tidak ditemukan!", "error");

                const { jsPDF } = window.jspdf;
                const doc = new jsPDF('p', 'mm', 'a4');
                const sd = it.samplingData || {};
                const regData = masterReg.find(r => r.name === it.reg) || { o2: 0, limit: '-' };

                // HALAMAN 1: COVER PAGE
                renderCoverPage(doc, it, sd, regData); 

                // HALAMAN 2: HASIL ANALISA (Tambahkan halaman baru)
                doc.addPage(); 
                renderResultsPage(doc, it, sd, regData); 

                // Output Final (Simpan PDF setelah semua halaman ditambahkan)
                doc.save(`COA_ES_${it.id}_FullReport.pdf`);
                showToast("PDF Certificate of Analysis berhasil diunduh!", "success");
            }

            function renderCoverPage(doc, it, sd, regData) {
                doc.setFont("helvetica", "bold");
                doc.setFontSize(16);
                doc.text("CERTIFICATE OF ANALYSIS", 105, 15, { align: "center" });

                doc.setFont("helvetica", "normal");
                doc.setFontSize(10);
                const certNo = `Certificate No: ES-${it.id}/${moment().format('YYYY')}`;
                doc.text(certNo, 105, 22, { align: "center" }); 
                
                // --- DRAW LINES FOR SECTION BOXES (Visuals like the image) ---
                const pageW = doc.internal.pageSize.getWidth();
                doc.line(20, 28, pageW - 20, 28);
               

                // --- SECTION 1: OWNERS IDENTITY ---
                doc.setFont("helvetica", "bold");
                doc.text("Owners Identity", 20, 38);
                doc.setFont("helvetica", "normal");
                doc.setFontSize(9);
                doc.text("Name of Company", 20, 47); doc.text(":", 60, 47); doc.text(it.company, 65, 47);
                doc.text("Address", 20, 52); doc.text(":", 60, 52); doc.text(it.companyLocation || '-', 65, 52);
                doc.text("Customer Contact", 20, 57); doc.text(":", 60, 57); doc.text(it.customerContact || '-', 65, 57); 
                doc.line(20, 69, pageW - 20, 69);   
                // --- SECTION 2: CUSTOMER JOB REFFERENCE ---
                doc.setFont("helvetica", "bold");
                doc.text("Customer Job Refference", 20, 79);
                doc.setFont("helvetica", "normal");
                doc.text("Subject test", 20, 89); doc.text(":", 60, 89); doc.text("Air Emissions Stationary Source", 65, 89);

                
               // --- SECTION 3: LAB FACILITIES & SAMPLING ---
                doc.setFont("helvetica", "normal");
                const tglSamplingCover = sd.tgl ? moment(sd.tgl).format('MMMM DD, YYYY') : '-';

                // TAMBAHKAN "DD-MM-YYYY" di dalam fungsi moment agar tidak tertukar jadi April
                const baseDate = moment(it.date, "DD-MM-YYYY"); 

                const dateAcceptance = baseDate.format('MMMM DD, YYYY'); 
                const dateAnalysisStart = baseDate.clone().add(1, 'days').format('MMMM DD, YYYY');
                const dateAnalysisEnd = baseDate.clone().add(2, 'days').format('MMMM DD, YYYY');

                doc.text("Sampled By", 20, 94); doc.text(":", 60, 94); doc.text("PT Envirotama Solusindo, Bekasi", 65, 94);
                doc.text("Date of Sampling", 20, 99); doc.text(":", 60, 99); doc.text(tglSamplingCover, 65, 99);
                doc.text("Lab Facilities", 20, 104); doc.text(":", 60, 104); doc.text("PT Envirotama Solusindo, Bekasi", 65, 104);

                // Hasil Sekarang: February 04, 2026
                doc.text("Date of Acceptance", 20, 109); doc.text(":", 60, 109); doc.text(dateAcceptance, 65, 109);

                // Hasil Sekarang: February 05, 2026 until February 06, 2026
                doc.text("Date of Analysis", 20, 114); doc.text(":", 60, 114); 
                doc.text(`${dateAnalysisStart} until ${dateAnalysisEnd}`, 65, 114);
                doc.line(20, 124, pageW - 20, 124);
                // --- SECTION 4: OTHER INFORMATION ---
                doc.setFont("helvetica", "bold");
                doc.text("Other Information", 20, 134);
                doc.setFont("helvetica", "normal");
                doc.text("Number of Pages", 20, 139); doc.text(":", 60, 139); doc.text("2 pages (Including this cover)", 65, 139);
                doc.text("Additional Notes", 20, 144); doc.text(":", 60, 144); doc.text(sd.note || '-', 65, 144);

                // --- TANDA TANGAN COVER ---
                const signYCover = 175;
                doc.setFont("helvetica", "normal"); doc.setFontSize(9); 
                const tglTerbit = `Cikarang, ${moment().format('MMMM DD, YYYY')}`;
                doc.text(tglTerbit, 145, signYCover);
                doc.setFont("helvetica", "bold");
                doc.text("Approved by", 145, signYCover + 5);
                doc.setFont("helvetica", "normal");
                doc.text("Technical Manager", 145, signYCover + 39);
                doc.line(145, signYCover + 40, 185, signYCover + 40); 
                doc.setFont("helvetica", "normal"); doc.text("Environment Lab Manager", 145, signYCover + 45);

                // --- FOOTER DISCLAIMER ---
                doc.setFontSize(7.5);
                const disclaimer = "Unless stated that sampling done by the laboratory, the results reported relate to only samples received in the laboratory. This report should not be reproduced except in full without the written approval of PT Envirotama Solusindo. Complaints regarding this report are only accepted 7 days after delivered.";
                const splitDisclaimer = doc.splitTextToSize(disclaimer, pageW - 34);
                doc.text(splitDisclaimer, 20, 265);
                doc.text("Page 1 of 2", 190, 285, { align: "right" });
                
            }

            function renderResultsPage(doc, it, sd, regData) {
                doc.setFont("helvetica", "bold");
                doc.setFontSize(16);
                doc.setTextColor(44, 62, 80);
                doc.text("CERTIFICATE OF ANALYSIS", 105, 15, { align: "center" });

                doc.setFontSize(10);
                doc.setFont("helvetica", "normal");
                doc.setTextColor(0, 0, 0);

                const certNo = `Certificate No: ES-${it.id}/${moment().format('YYYY')}`;
                doc.text(certNo, 105, 22, { align: "center" }); 

                doc.line(20, 27, 190, 27); 

                // --- INFORMASI PELANGGAN & SAMPEL ---
                doc.setFont("helvetica", "normal");
                doc.setFontSize(8.5);
                
                // Kolom Kiri
                doc.text("Customer Name", 20, 35); doc.text(":", 60, 35); doc.text(it.company, 65, 35);
                doc.text("Subject Test", 20, 40); doc.text(":", 60, 40); doc.text("Air Emission - Stationary Source", 65, 40);
                doc.text("Sample ID / Location", 20, 45); doc.text(":", 60, 45); doc.text(`${it.id} / ${sd.lokasi || '-'}`, 65, 45);
                doc.text("Coordinate", 20, 50); doc.text(":", 60, 50); doc.text(sd.koordinat || '-', 65, 50);
                doc.text("Lab Number", 20, 55); doc.text(":", 60, 55); doc.text(`LAB-${it.id}`, 65, 55);
                        
                // Kolom Kanan
                const tglSampling = sd.tgl ? moment(sd.tgl).format('MMMM DD, YYYY') : it.date;
                const jamFormatted = sd.jam ? moment(sd.jam, 'HH:mm').format('hh:mm A') : '-';

                doc.text("Sampling Doc. No.", 120, 35); doc.text(": -", 155, 35);
                doc.text("Sampling Date", 120, 40); doc.text(`: ${tglSampling}`, 155, 40);
                doc.text("Sampling Time", 120, 45); doc.text(`: ${jamFormatted}`, 155, 45);
                doc.text("Sampling Condition", 120, 50); doc.text(`: ${sd.cuaca || 'Weather is Clear'}`, 155, 50); 
                doc.text("Date of Analysis", 120, 55); doc.text(`: ${it.date}`, 155, 55);
                doc.text("Sampling Method", 120, 60); doc.text(": Isokinetic", 155, 60);

                doc.line(20, 65, 190, 65);

                // --- TABEL HASIL PENGUJIAN ---
                const tableColumn = ["No.", "Testing Parameter", "Sample Result", "Regulatory Limit**", "Unit#", "Methods"];
                const tableRows = [[1, it.param, it.res, regData.limit, "mg/NmÂ³", it.met],
                    [2, "Oksigen (O2)", sd.o2_lapangan, "-", "%", "IKM-ESP-7.2.5"],
                    [3, "Velocity", sd.velocity, "-", "m/s", it.met],
                    [4, "Volumetric Flow Rate", sd.flowRate, "-", "mÂ³/s", it.met],
                    [5, "Water Vapor in flue gas", sd.waterVapor, "-", "%", it.met],
                    [6, "Num of Traverse Point", sd.traversePoint, "-", "-", it.met],
                    [7, "Percent of Isokinetic", sd.isokinetic, "90-110", "%", it.met]];

                doc.autoTable({startY: 75, head: [tableColumn], body: tableRows, theme: 'grid', 
                    headStyles: { fillColor: [200, 200, 200], textColor: [0, 0, 0], fontStyle: 'bold', fontSize: 8, halign: 'center' },
                    styles: { fontSize: 7.5, cellPadding: 2, halign: 'center', valign: 'middle'},
                    columnStyles: {0: { halign: 'center', cellWidth: 8 }, 1: { halign: 'left', cellWidth: 50 }, 
                    2: { halign: 'center', fontStyle: 'bold', cellWidth: 25 }, 3: { halign: 'center', cellWidth: 30 }, 
                    4: { halign: 'center', cellWidth: 15 }, 5: { halign: 'left', cellWidth: 40 }}});

                // --- CATATAN TEKNIS (KOREKSI O2) ---
                const finalY = doc.lastAutoTable.finalY + 10;
                doc.setFontSize(8); doc.setFont("helvetica", "bold"); doc.text("Note:", 20, finalY);
                doc.setFont("helvetica", "normal"); doc.setFontSize(7.5);
                doc.text("**", 20, finalY + 5); doc.text(it.reg, 27, finalY + 5); 
                doc.text("#", 20, finalY + 10); doc.text("mg/mÂ³ = Concentration of miligram per meter cubic, at normal atmosfer, Pressure 1 atm and temperature 25Â°C", 27, finalY + 10);

                // --- TANDA TANGAN ---
                const signY = finalY + 25; 
                doc.setFont("helvetica", "normal"); doc.setFontSize(9);
                const tglTerbit = moment().format('MMMM DD, YYYY');
                doc.text(`Cikarang, ${tglTerbit}`, 145, signY);
                doc.setFont("helvetica", "bold"); doc.text("Approved by,", 145, signY + 5);
                doc.text("nama manajer", 145, signY + 35); 
                doc.line(145, signY + 36, 185, signY + 36); 
                doc.setFont("helvetica", "normal"); doc.text("Environment Lab Manager", 145, signY + 41);

                // --- FOOTER HALAMAN ---
                doc.setFontSize(7.5); doc.setFont("helvetica", "normal");
                doc.text("This report shall not be reproduced except in full, without written approval of the laboratory.", 105, 285, { align: "center" });
                doc.text("Page 2 of 2", 190, 285, { align: "right" });
            }

        function exportJSON() {

            const backupData = {
                system: "LIMS ENVIRONMENT LAB SYSTEM by Muhammad Rifai",
                version: "1.0",
                exportedAt: new Date().toLocaleString("id-ID"),

                checksum: btoa(
                    JSON.stringify({
                        db,
                        masterReg,
                        masterMap
                    })
                ),

                totalDB: db.length,
                totalLogs: logs.length,
                totalRecycle: recycleBin.length,

                data: {
                    db,
                    masterReg,
                    masterMap,
                    logs,
                    recycleBin
                }
            };

            const formattedJSON = JSON.stringify(backupData, null, 4);

            const blob = new Blob([formattedJSON], { type: "application/json" });

            const url = URL.createObjectURL(blob);

            const a = document.createElement("a");
            a.href = url;

            const timestamp = new Date().toISOString().split("T")[0];
            a.download = `LIMS_ES_BACKUP_${timestamp}.json`;

            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);

            URL.revokeObjectURL(url);

            showToast("Backup berhasil diekspor", "success");
        }


        function importJSON(e){

            const file = e.target.files[0];
            if(!file) return;

            file.text().then(result => {

                try{

                    const data = JSON.parse(result);

                    // ===== VALIDASI DASAR =====
                    if(!data || !data.data){
                        throw new Error("Backup tidak valid");
                    }

                    // ===== VALIDASI SIGNATURE SYSTEM =====
                    if(
                        data.system !== "LIMS ENVIRONMENT LAB SYSTEM by Muhammad Rifai" ||
                        !data.version
                    ){
                        throw new Error("File bukan backup resmi sistem");
                    }

                    const backup = data.data;

                    if(!Array.isArray(backup.db) || !Array.isArray(backup.masterReg)){
                        throw new Error("Struktur backup rusak");
                    }

                    // ===== RESTORE =====
                    db = backup.db || [];
                    masterReg = backup.masterReg || [];
                    masterMap = backup.masterMap || {};
                    logs = backup.logs || [];
                    recycleBin = backup.recycleBin || [];

                    // ===== SAVE LOCAL =====
                    localStorage.setItem('lab_final_db', JSON.stringify(db));
                    localStorage.setItem('lab_final_reg', JSON.stringify(masterReg));
                    localStorage.setItem('lab_final_map', JSON.stringify(masterMap));
                    localStorage.setItem('lab_audit_logs', JSON.stringify(logs));
                    localStorage.setItem('lab_recycle_bin', JSON.stringify(recycleBin));

                    updateMasterUI();
                    renderTables();
                    updateStats();

                    if(typeof renderLogs === 'function') renderLogs();
                    if(typeof renderRecycleBin === 'function') renderRecycleBin();

                    showToast("Database berhasil dipulihkan", "success");

                    e.target.value = "";

                }catch(err){
                    console.error(err);
                    showToast(err.message || "Format backup tidak valid", "error");
                }

            });

        }


        function resetDB() {

            if(confirm("Hapus seluruh database sistem?")){

                localStorage.clear();
                location.reload();

            }
        }
        

        function showToast(m, t="success") {
            const c = document.getElementById('toast-container');
            const b = document.createElement('div'); b.className='toast'; b.innerText=m;
            if(t==='error') b.style.background='var(--danger)';
            c.appendChild(b); setTimeout(() => b.remove(), 3000);
        }

        function deleteAnalisa(i) {
            const it = JSON.parse(JSON.stringify(db[i]));
            if (confirm(`Pindahkan Sampel ID: ${it.id} ke Tempat Sampah?`)) {
                // 1. Tambahkan informasi waktu penghapusan
                it.deletedAt = new Date().toLocaleString('id-ID');
                
                // 2. Pindahkan ke array recycleBin
                recycleBin.unshift(it);
                
                // 3. Hapus dari database aktif
                db.splice(i, 1);
                
                // 4. Simpan ke localStorage
                localStorage.setItem('lab_final_db', JSON.stringify(db));
                localStorage.setItem('lab_recycle_bin', JSON.stringify(recycleBin));
                
                // 5. Catat Log
                addLog("RECYCLE", `ID: ${it.id} dipindahkan ke Tempat Sampah`);
                
                renderTables();
                updateStats();
                showToast("Data dipindahkan ke Tempat Sampah", "warning");
            }
        }

        function renderRecycleBin() {
            const bR = document.getElementById('body-recycle');
            if (!bR) return;
            
            bR.innerHTML = recycleBin.map((it, idx) => `
                <tr>
                    <td><strong>${it.id}</strong> - ${it.company}</td>
                    <td><small>${it.deletedAt}</small></td>
                    <td>
                        <button onclick="restoreData(${idx})" class="btn-primary" style="background:var(--success); font-size:0.7rem;">
                            <i class="fas fa-undo"></i> Restore
                        </button>
                        <button onclick="permanentDelete(${idx})" class="btn-primary" style="background:var(--danger); font-size:0.7rem;">
                            Hapus Permanen
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        function restoreData(idx) {
            const it = recycleBin[idx];
            
            // 1. Masukkan kembali ke database utama
            if (db.some(d => d.id === it.id)) {
                showToast("ID sudah ada di sistem!", "error");
                return;
            } 
            
            // 2. Hapus dari daftar tempat sampah
            recycleBin.splice(idx, 1); 
            
            // 3. Simpan KEDUA perubahan ke LocalStorage
            localStorage.setItem('lab_final_db', JSON.stringify(db));
            localStorage.setItem('lab_recycle_bin', JSON.stringify(recycleBin));
            
            // 4. Catat Log
            addLog("RESTORE", `Mengembalikan Sampel ID: ${it.id} ke sistem aktif.`);
            
            // 5. REFRESH TAMPILAN (Sangat Penting)
            renderRecycleBin(); // Update tabel tempat sampah
            renderTables();     // Update tabel Analisa & CoA
            updateStats();      // Update angka di dashboard
            
            showToast(`Data ID ${it.id} Berhasil Dipulihkan!`, "success");
        }

        function updateStats() {
            if (!db) return;

            // 1. Hitung Data (Konsisten dengan tabel)
            const totalMasuk = [...new Set(db.map(i => i.id))].length;
            const totalAnalisa = db.filter(i => i.isV === false).length;
            const totalSelesai = db.filter(i => i.isV === true).length;

            // 2. Update Angka Dashboard (Card Atas)
            const elMasuk = document.getElementById('stat-total');
            const elProses = document.getElementById('stat-proses');
            const elSelesai = document.getElementById('stat-selesai');

            if(elMasuk) elMasuk.innerText = totalMasuk;
            if(elProses) elProses.innerText = totalAnalisa;
            if(elSelesai) elSelesai.innerText = totalSelesai;

            // 3. Update Badge Sidebar (Gunakan querySelector untuk menghindari ID null)
            const badgeAnl = document.getElementById('badge-analisa');
            const badgeSel = document.getElementById('badge-coa');

            if (badgeAnl) {
                badgeAnl.innerText = totalAnalisa;
                badgeAnl.style.display = 'inline-block'; // Angka 0 tetap muncul
                badgeAnl.style.background = totalAnalisa > 0 ? 'var(--danger)' : '#cbd5e1';
            }

            if (badgeSel) {
                badgeSel.innerText = totalSelesai;
                badgeSel.style.display = 'inline-block'; // Angka 0 tetap muncul
                badgeSel.style.background = totalSelesai > 0 ? 'var(--success)' : '#cbd5e1';
            }

            // 4. Update Grafik dengan data yang sudah dihitung
            updateChart(totalMasuk, totalAnalisa, totalSelesai);
        }
        

            function addLog(action, details) {
                // Ambil role langsung dari sessionStorage setiap kali log dibuat
                const currentUser = sessionStorage.getItem('role') || 'System'; 

                const newLog = {
                    timestamp: new Date().toLocaleString('id-ID'),
                    user: currentUser, // Pastikan variabel ini 'currentUser'
                    action: action,
                    details: details
                };
                
                logs.unshift(newLog);
                if(logs.length > 500) logs.pop(); 
                localStorage.setItem('lab_audit_logs', JSON.stringify(logs));
            }

            function logWeightChange(sampleId, jenisBobot, oldVal, newVal) {
                // Hanya catat jika nilai benar-benar berubah
                if (oldVal !== newVal) {
                    const valLama = oldVal || "Kosong";
                    const valBaru = newVal || "Kosong";
                    addLog("EDIT BOBOT", `ID: ${sampleId} | ${jenisBobot} dirubah dari [${valLama}] menjadi [${valBaru}] gram`);
                }
            }

            function processWeightChange(idx, field, label, inputEl, vol) {
                const newVal = inputEl.value;
                const oldVal = inputEl.oldValue || "";
                const sampleId = db[idx].id;

                // 1. Peringatan jika merubah data yang sudah ada
                if (oldVal !== "" && oldVal !== newVal) {
                    if (!confirm(`âš ï¸ PERINGATAN: Mengubah data ${label} yang sudah tersimpan dapat merubah hasil analisa. Yakin?`)) {
                        inputEl.value = oldVal;
                        return;
                    }
                }

                // 2. Simpan jika ada perubahan
                if (oldVal !== newVal) {
                    db[idx][field] = newVal;
                    addLog('EDIT BOBOT', `ID: ${sampleId} | ${label} [${oldVal || '0'}] -> [${newVal}]`);
                    
                    // Simpan ke LocalStorage
                    localStorage.setItem('lab_final_db', JSON.stringify(db));
                    
                    // Hitung ulang hasil
                    hitungTotalPartikulat(idx, vol);
                    
                    // Efek visual sukses
                    inputEl.style.backgroundColor = "#f0fdf4"; // Hijau sekejap
                    setTimeout(() => inputEl.style.backgroundColor = "white", 1000);
                    showToast("Data Disimpan Secara Otomatis", "success");
                }
            }

            function exportExcel() {
                const verifiedData = db.filter(it => it.isV);
                if (verifiedData.length === 0) return showToast("Tidak ada data terverifikasi!", "error");
            
                const wb = XLSX.utils.book_new();
            
                verifiedData.forEach((it) => {
                    const sd = it.samplingData || {};
                    const regData = masterReg.find(r => r.name === it.reg) || { o2: 0, limit: '-' };
                    const baseDate = moment(it.date, "DD-MM-YYYY", true);
                    const safeDate = baseDate.isValid() 
                        ? baseDate.format('MMMM DD, YYYY') 
                        : "-";
                    
                    // --- DATA STRUKTUR EXCEL (Sama Persis Alur PDF) ---
                    let sheetContent = [
                        ["CERTIFICATE OF ANALYSIS"], // Baris 1
                        [`Certificate No: ES-${it.id}/${moment().format('YYYY')}`],
                        [""],
                        ["[ HALAMAN 1: OWNERS IDENTITY ]"],
                        ["Name of Company", ": " + it.company],
                        ["Address", ": " + (it.companyLocation || "-")],
                        ["Customer Contact", ": " + (it.customerContact || "-")],
                        [""],
                        ["[ CUSTOMER JOB REFERENCE ]"],
                        ["Subject Test", ": Air Emissions Stationary Source"],
                        ["Sampled By", ": PT Envirotama Solusindo, Bekasi"],
                        ["Date of Sampling", ": " + (sd.tgl ? moment(sd.tgl).format('MMMM DD, YYYY') : "-")],
                        ["Lab Facilities", ": PT Envirotama Solusindo, Bekasi"],
                        ["Date of Acceptance", ": " + baseDate.format('MMMM DD, YYYY')],
                        ["Date of Analysis", ": " + baseDate.clone().add(1, 'days').format('MMMM DD, YYYY') + " until " + baseDate.clone().add(2, 'days').format('MMMM DD, YYYY')],
                        [""],
                        ["[ OTHER INFORMATION ]"],
                        ["Additional Notes", ": " + (sd.note || "-")],
                        [""],
                        ["--------------------------------------------------------------------------------"],
                        [""],
                        ["[ HALAMAN 2: TEST RESULTS ]"],
                        ["Sample ID / Location", ": " + it.id + " / " + (sd.lokasi || "-")],
                        ["Coordinate", ": " + (sd.koordinat || "-")],
                        ["Sampling Condition", ": " + (sd.cuaca || "Clear")],
                        ["Sampling Method", ": Isokinetic"],
                        [""],
                        // --- HEADER TABEL HASIL ---
                        ["No.", "Testing Parameter", "Sample Result", "Regulatory Limit**", "Unit#", "Methods", "O2 Reg (%)"],
                        [1, it.param, it.res, regData.limit, "mg/NmÂ³", it.met, regData.o2],
                        [2, "Oksigen (O2)", sd.o2_lapangan || "20.9", "-", "%", "IKM-ESP-7.2.5", "-"],
                        [3, "Velocity", sd.velocity || "-", "-", "m/s", it.met, "-"],
                        [4, "Volumetric Flow Rate", sd.flowRate || "-", "-", "mÂ³/s", it.met, "-"],
                        [5, "Water Vapor", sd.waterVapor || "-", "-", "%", it.met, "-"],
                        [6, "Num of Traverse Point", sd.traversePoint || "-", "-", "-", it.met, "-"],
                        [7, "Percent of Isokinetic", sd.isokinetic || "-", "90-110", "%", it.met, "-"],
                        [""],
                        ["Note:"],
                        ["**", it.reg],
                        ["#", "mg/mÂ³ = Concentration of miligram per meter cubic, at normal atmosfer (25Â°C, 1 atm)"],
                        [""],
                        ["Approved by,"],
                        [""],
                        [""],
                        ["Technical Manager"],
                        ["PT ENVIROTAMA SOLUSINDO"]
                    ];
            
                    // Buat Worksheet
                    const ws = XLSX.utils.aoa_to_sheet(sheetContent);
                    
                    // Atur Lebar Kolom (wch = width in characters)
                    ws['!cols'] = [
                        { wch: 20 }, // Kolom A (Label)
                        { wch: 40 }, // Kolom B (Value / Parameter)
                        { wch: 15 }, // Result
                        { wch: 20 }, // Limit
                        { wch: 10 }, // Unit
                        { wch: 25 }, // Methods
                        { wch: 12 }  // O2 Reg
                    ];
            
                    // Tambahkan ke Workbook (Nama Sheet = ID Sampel)
                    XLSX.utils.book_append_sheet(wb, ws, it.id.substring(0, 30));
                });
            
                // Download File
                XLSX.writeFile(wb, `COA_FULL_REPORT_ES_${moment().format('YYYYMMDD')}.xlsx`);
                addLog("EXPORT EXCEL", `Ekspor ${verifiedData.length} Laporan Lengkap ke Excel`);
                showToast("Excel Laporan Lengkap (Halaman 1 & 2) Berhasil Diunduh!");
            }


        
           function printCOC() {

                if (!window.jspdf) {
                    alert("jsPDF belum terload!");
                    return;
                }

                const { jsPDF } = window.jspdf;
                const doc = new jsPDF('l', 'mm', 'a4');

                const pageW = doc.internal.pageSize.getWidth();
                const pageH = doc.internal.pageSize.getHeight();
                const margin = 10;

                const getVal = (id) => {
                    const el = document.getElementById(id);
                    return el ? el.value : '';
                };

                // ===============================
                // 1. HEADER
                // ===============================

                doc.setDrawColor(150);
                doc.rect(margin, 8, 30, 15);
                doc.setFontSize(7);
                doc.text("LOGO", margin + 11, 17);

                doc.setFont("helvetica", "bold");
                doc.setFontSize(12);
                doc.text("LABORATORIUM PT ENVIROTAMA SOLUSINDO", margin + 35, 12);

                doc.setFont("helvetica", "normal");
                doc.setFontSize(7.5);
                doc.text("Jl. Jatiwangi No.84 Kamurang, Cikarang Barat, Bekasi 17530", margin + 35, 16);
                doc.text("Phone: +6221-85934498", margin + 35, 19);
                doc.text("Email: sales2@eslab.co.id | www.eslab.co.id", margin + 35, 22);

                doc.setFontSize(14);
                doc.setFont("helvetica", "bold");
                doc.text("CHAIN OF CUSTODY (COC)", pageW - margin, 18, { align: "right" });

                doc.line(margin, 26, pageW - margin, 26);

                // ===============================
                // 2. INFO TABLE
                // ===============================

                doc.autoTable({
                    startY: 30,
                    theme: 'grid',
                    styles: { fontSize: 8, cellPadding: 1.5 },
                    columnStyles: {
                        0: { fontStyle: 'bold', cellWidth: 35, fillColor: [240,240,240] },
                        2: { fontStyle: 'bold', cellWidth: 30, fillColor: [240,240,240] },
                        4: { fontStyle: 'bold', cellWidth: 30, fillColor: [240,240,240] }
                    },
                    body: [
                        [
                            'Company Name', getVal('coc-company-name'),
                            {content: 'Email (COA)', rowSpan: 2}, {content: getVal('coc-email-coa'), rowSpan: 2},
                            'COC No.', getVal('coc-coc-no')
                        ],
                        [
                            'Company Address', getVal('coc-company-address'),
                            'LTR No.', getVal('coc-ltr-no')
                        ],
                        [
                            {content: 'Sampling Location', rowSpan: 2}, {content: getVal('coc-company-location-detail'), rowSpan: 2},
                            'TAT Requested', getVal('coc-tat-req'),
                            'Sampling Officer', getVal('coc-officer-a')
                        ],
                        [
                            'Sampling Plan Date', getVal('coc-plan-date'),
                            'Sampling Officer 2', getVal('coc-officer-b')
                        ],
                        [
                            'PIC', getVal('coc-pic'),
                            'Phone No.', getVal('coc-phone-no'),
                            'Sampling Officer 3', getVal('coc-officer-c')
                        ]
                    ],
                    margin: { left: margin, right: margin }
                });

                let lastY = doc.lastAutoTable.finalY;

                // ===============================
                // 3. SAMPLE TABLE (GROUPED)
                // ===============================

                const sampleHead = [[
                    'No.',
                    'Sample ID',
                    'Description',
                    'Matrix',
                    'Container',
                    'Regulation',
                    'Parameter',
                    'Method'
                ]];

                const sampleBody = [];
                const rows = document.querySelectorAll("#coc-samples-body tr");

                let sampleMap = {};
                let counter = 1;

                rows.forEach(row => {

                    const inputs = row.querySelectorAll("td input");

                    const sampleId = inputs[0]?.value || "";
                    if (!sampleId) return;

                    const description = inputs[1]?.value || "";
                    const matrix = inputs[2]?.value || "";
                    const container = inputs[3]?.value || "";

                    const regulation = row.querySelector(".reg-select")?.value || "";
                    const parameter = row.querySelector(".param-select")?.value || "";
                    const method = row.querySelector(".method-select")?.value || "";

                    if (!sampleMap[sampleId]) {
                        sampleMap[sampleId] = {
                            no: counter++,
                            sampleId,
                            description,
                            matrix,
                            container,
                            regulation,
                            tests: []
                        };
                    }

                    sampleMap[sampleId].tests.push({
                        parameter,
                        method
                    });

                });

                Object.values(sampleMap).forEach(sample => {

                    sample.tests.forEach((test, index) => {

                        sampleBody.push([
                            index === 0 ? sample.no : "",
                            index === 0 ? sample.sampleId : "",
                            index === 0 ? sample.description : "",
                            index === 0 ? sample.matrix : "",
                            index === 0 ? sample.container : "",
                            index === 0 ? sample.regulation : "",
                            test.parameter || "-",
                            test.method || "-"
                        ]);

                    });

                });

                doc.autoTable({
                    startY: lastY + 5,
                    head: sampleHead,
                    body: sampleBody,
                    theme: 'grid',
                    headStyles: {
                        fillColor: [40,40,40],
                        fontSize: 8,
                        halign: 'center'
                    },
                    styles: {
                        fontSize: 7,
                        halign: 'center',
                        valign: 'middle'
                    },
                    margin: { left: margin, right: margin }
                });

                lastY = doc.lastAutoTable.finalY;

                // ===============================
                // 4. SAMPLE CONDITION
                // ===============================

                doc.autoTable({
                    startY: lastY + 5,
                    theme: 'grid',
                    styles: { fontSize: 7.5 },
                    body: [
                        [{ content: 'Sample Condition Upon Reception', styles: { fontStyle: 'bold', fillColor: [220,220,220] } }],
                        ['a. Suitability: [ ] No discrepancy   [ ] There is discrepancy'],
                        ['b. Method conformity: [ ] Yes   [ ] No'],
                        ['c. Sample condition: [ ] Good   [ ] Not good'],
                        ['d. Notes: _______________________________________________']
                    ],
                    margin: { left: margin, right: margin }
                });

                lastY = doc.lastAutoTable.finalY;

                // ===============================
                // 5. SIGNATURE TABLE
                // ===============================

                doc.autoTable({
                    startY: lastY + 5,
                    head: [[
                        'Issued by',
                        'Approved (Tech Mgr)',
                        'Verified by',
                        'Sampling Officer',
                        'Received by',
                        'Customer Approval'
                    ]],
                    body: [['\n\n\n\n', '', '', '', '', '']],
                    theme: 'grid',
                    styles: { fontSize: 7, halign: 'center' },
                    headStyles: { fillColor: [220,220,220] },
                    margin: { left: margin, right: margin }
                });

                // ===============================
                // 6. PAGE NUMBER
                // ===============================

                const pageCount = doc.internal.getNumberOfPages();

                for (let i = 1; i <= pageCount; i++) {
                    doc.setPage(i);
                    doc.setFontSize(7);
                    doc.text(
                        `Page ${i} of ${pageCount}`,
                        pageW - margin,
                        pageH - 5,
                        { align: 'right' }
                    );
                }

                // ===============================
                // 7. SAVE FILE
                // ===============================

                const cleanComp = (getVal('coc-company-name') || 'Export')
                    .replace(/[/\\?%*:|"<>]/g, '-');

                const fileName =
                    `COC_${cleanComp}_${getVal('coc-coc-no') || 'Draft'}.pdf`;

                doc.save(fileName);
            }

            const supabaseClient = supabase.createClient(
                "https://quhyhvwzxhulzmecbglv.supabase.co",
                "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InF1aHlodnd6eGh1bHptZWNiZ2x2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE5NjUzNTMsImV4cCI6MjA4NzU0MTM1M30.73s0ubjBvJ-xxBAA6WjLlnXWwe4gpbNuF_cYfavl22o"
            );

            window.supabaseClient = supabaseClient;

    </script>
</body>
</html>