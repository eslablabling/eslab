<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>LIMS ES - Full Version</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>

<style>
body{font-family:Arial;background:#f1f5f9;margin:0;padding:20px}
h2{margin-top:40px}
button{padding:8px 14px;border:none;border-radius:6px;background:#2563eb;color:white;cursor:pointer}
input,select{padding:6px;border:1px solid #ccc;border-radius:6px}
table{width:100%;border-collapse:collapse;margin-top:10px;background:white}
th,td{border:1px solid #ddd;padding:6px;font-size:12px;text-align:center}
th{background:#1e293b;color:white}
.section{background:white;padding:15px;border-radius:10px;margin-bottom:30px}
.toast{position:fixed;bottom:20px;right:20px;background:#16a34a;color:white;padding:10px;border-radius:6px}
</style>
</head>
<body>

<h1>LIMS PT Envirotama Solusindo</h1>

<div class="section">
<h2>CHAIN OF CUSTODY</h2>

<input id="coc-number" placeholder="COC Number">
<input id="coc-company" placeholder="Company Name">
<button onclick="addCocRow()">Tambah Sampel</button>

<table>
<thead>
<tr>
<th>No</th><th>Sample ID</th><th>Parameter</th><th>Metode</th><th>Action</th>
</tr>
</thead>
<tbody id="coc-body"></tbody>
</table>

<br>
<button onclick="saveCoc()">Simpan COC</button>
<button onclick="printCOC()">Print COC</button>
</div>

<div class="section">
<h2>ANALISA</h2>
<table>
<thead>
<tr>
<th>ID</th><th>Company</th><th>Parameter</th><th>Metode</th><th>Result</th><th>Verify</th><th>COA</th><th>Delete</th>
</tr>
</thead>
<tbody id="analisa-body"></tbody>
</table>
</div>

<div class="section">
<h2>RECYCLE BIN</h2>
<table>
<thead><tr><th>ID</th><th>Restore</th></tr></thead>
<tbody id="bin-body"></tbody>
</table>
</div>

<div class="section">
<h2>BACKUP</h2>
<button onclick="exportJSON()">Export Backup</button>
<input type="file" onchange="importJSON(event)">
</div>

<div id="toast-container"></div>

<script>

let cocTemp = [];
let cocDB = JSON.parse(localStorage.getItem('lab_coc_db'))||[];
let db = JSON.parse(localStorage.getItem('lab_db'))||[];
let recycleBin = JSON.parse(localStorage.getItem('lab_bin'))||[];
let logs = JSON.parse(localStorage.getItem('lab_logs'))||[];

function showToast(msg){
const t=document.createElement("div");
t.className="toast";
t.innerText=msg;
document.body.appendChild(t);
setTimeout(()=>t.remove(),3000);
}

function addLog(action,detail){
logs.unshift({
time:new Date().toLocaleString(),
action,detail
});
localStorage.setItem("lab_logs",JSON.stringify(logs));
}

function addCocRow(){
cocTemp.push({sampleId:'',parameter:'',metode:''});
renderCoc();
}

function renderCoc(){
const body=document.getElementById("coc-body");
body.innerHTML='';
cocTemp.forEach((s,i)=>{
body.innerHTML+=`
<tr>
<td>${i+1}</td>
<td><input onchange="cocTemp[${i}].sampleId=this.value"></td>
<td><input onchange="cocTemp[${i}].parameter=this.value"></td>
<td><input onchange="cocTemp[${i}].metode=this.value"></td>
<td><button onclick="cocTemp.splice(${i},1);renderCoc()">Hapus</button></td>
</tr>
`;
});
}

function saveCoc(){
const number=document.getElementById("coc-number").value;
const company=document.getElementById("coc-company").value;

if(!number||cocTemp.length==0){alert("Lengkapi data");return;}

if(cocDB.some(c=>c.number==number)){alert("COC sudah ada");return;}

const newCoc={number,company,date:new Date(),samples:cocTemp};
cocDB.push(newCoc);
localStorage.setItem("lab_coc_db",JSON.stringify(cocDB));

cocTemp.forEach(s=>{
db.push({
id:s.sampleId,
company,
param:s.parameter,
met:s.metode,
result:'',
isV:false,
date:moment().format("DD-MM-YYYY")
});
});

localStorage.setItem("lab_db",JSON.stringify(db));
addLog("CREATE COC",number);

cocTemp=[];
renderCoc();
renderAnalisa();
showToast("COC Disimpan & Analisa Dibuat");
}

function renderAnalisa(){
const body=document.getElementById("analisa-body");
body.innerHTML='';
db.forEach((d,i)=>{
body.innerHTML+=`
<tr>
<td>${d.id}</td>
<td>${d.company}</td>
<td>${d.param}</td>
<td>${d.met}</td>
<td><input value="${d.result||''}" onchange="updateResult(${i},this.value)"></td>
<td><button onclick="verify(${i})">${d.isV?'Verified':'Verify'}</button></td>
<td><button onclick="printCOA(${i})">COA</button></td>
<td><button onclick="deleteData(${i})">Delete</button></td>
</tr>
`;
});
}

function updateResult(i,val){
db[i].result=val;
localStorage.setItem("lab_db",JSON.stringify(db));
}

function verify(i){
if(!db[i].result){alert("Isi hasil dulu");return;}
db[i].isV=true;
localStorage.setItem("lab_db",JSON.stringify(db));
addLog("VERIFY",db[i].id);
renderAnalisa();
}

function deleteData(i){
recycleBin.push(db[i]);
db.splice(i,1);
localStorage.setItem("lab_db",JSON.stringify(db));
localStorage.setItem("lab_bin",JSON.stringify(recycleBin));
renderAnalisa();
renderBin();
}

function renderBin(){
const body=document.getElementById("bin-body");
body.innerHTML='';
recycleBin.forEach((d,i)=>{
body.innerHTML+=`
<tr>
<td>${d.id}</td>
<td><button onclick="restore(${i})">Restore</button></td>
</tr>`;
});
}

function restore(i){
db.push(recycleBin[i]);
recycleBin.splice(i,1);
localStorage.setItem("lab_db",JSON.stringify(db));
localStorage.setItem("lab_bin",JSON.stringify(recycleBin));
renderAnalisa();
renderBin();
}

function printCOA(i){
if(!db[i].isV){alert("Belum verify");return;}
const {jsPDF}=window.jspdf;
const doc=new jsPDF();
doc.text("CERTIFICATE OF ANALYSIS",20,20);
doc.text("ID: "+db[i].id,20,30);
doc.text("Company: "+db[i].company,20,40);
doc.text("Parameter: "+db[i].param,20,50);
doc.text("Result: "+db[i].result,20,60);
doc.save("COA_"+db[i].id+".pdf");
}

function printCOC(){
const {jsPDF}=window.jspdf;
const doc=new jsPDF('l');
doc.text("CHAIN OF CUSTODY",20,20);
doc.autoTable({
head:[["No","Sample ID","Parameter","Metode"]],
body:cocTemp.map((s,i)=>[i+1,s.sampleId,s.parameter,s.metode])
});
doc.save("COC.pdf");
}

function exportJSON(){
const blob=new Blob([JSON.stringify({db,cocDB,recycleBin,logs})],{type:"application/json"});
const a=document.createElement("a");
a.href=URL.createObjectURL(blob);
a.download="backup_lims.json";
a.click();
}

function importJSON(e){
const file=e.target.files[0];
file.text().then(txt=>{
const data=JSON.parse(txt);
db=data.db||[];
cocDB=data.cocDB||[];
recycleBin=data.recycleBin||[];
logs=data.logs||[];
localStorage.setItem("lab_db",JSON.stringify(db));
localStorage.setItem("lab_coc_db",JSON.stringify(cocDB));
localStorage.setItem("lab_bin",JSON.stringify(recycleBin));
localStorage.setItem("lab_logs",JSON.stringify(logs));
renderAnalisa();
renderBin();
});
}

renderAnalisa();
renderBin();

</script>
</body>
</html>
